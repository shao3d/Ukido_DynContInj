name: ðŸ“Š Update Architecture Diagrams

on:
  push:
    branches: [main]
    paths:
      - 'src/**/*.py'
      - '.github/workflows/update-diagrams.yml'
  workflow_dispatch:  # ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ

jobs:
  generate-diagrams:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # ÐÑƒÐ¶Ð½Ð¾ Ð´Ð»Ñ push Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ð¾ Ð² Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ðŸ“¦ Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz
      
      - name: ðŸ“š Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install pydeps
          pip install code2flow
          pip install pyreverse || pip install pylint  # pyreverse Ñ‡Ð°ÑÑ‚ÑŒ pylint
      
      - name: ðŸ—‚ï¸ Create diagrams directory
        run: mkdir -p docs/diagrams
      
      - name: ðŸ” Generate dependency graph with pydeps
        run: |
          echo "Generating dependency graph..."
          pydeps src \
            --max-bacon=2 \
            --cluster \
            --noshow \
            -o docs/diagrams/dependencies.svg || echo "pydeps failed, continuing..."
      
      - name: ðŸ”„ Generate call flow with code2flow
        run: |
          echo "Generating call flow diagram..."
          code2flow src/ \
            --output docs/diagrams/call_flow.png \
            --no-trimming \
            --hide-legend || echo "code2flow failed, continuing..."
      
      - name: ðŸ“ Generate UML with pyreverse
        run: |
          echo "Generating UML class diagram..."
          pyreverse -o png -p Ukido src/*.py \
            -d docs/diagrams/ || echo "pyreverse failed, continuing..."
      
      - name: ðŸ“ Generate simple architecture overview
        run: |
          cat > docs/diagrams/architecture_overview.md << 'EOF'
          # ðŸ—ï¸ Ukido Architecture Diagrams
          
          Auto-generated on: $(date)
          
          ## ðŸ“Š Available Diagrams:
          
          ### 1. Dependencies Graph
          ![Dependencies](./dependencies.svg)
          
          ### 2. Call Flow
          ![Call Flow](./call_flow.png)
          
          ### 3. UML Classes
          ![Classes](./classes_Ukido.png)
          
          ## ðŸ”„ Update Schedule
          These diagrams are automatically updated when:
          - Python files in `src/` are modified
          - This workflow file is updated
          - Manually triggered from Actions tab
          
          ## ðŸ“¦ Project Structure
          - **Router**: Gemini-based intent classification
          - **Generator**: Claude-based response generation
          - **History**: Context management (last 10 messages)
          - **Social**: Social intent handling
          EOF
          date >> docs/diagrams/architecture_overview.md
      
      - name: ðŸ“Š Check what was generated
        run: |
          echo "Generated files:"
          ls -la docs/diagrams/
      
      - name: ðŸ’¾ Commit and push diagrams
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/diagrams/
          git diff --quiet && git diff --staged --quiet || (
            git commit -m "ðŸ¤– Update architecture diagrams [skip ci]
            
            Auto-generated diagrams:
            - Dependency graph (pydeps)
            - Call flow (code2flow)
            - UML classes (pyreverse)
            
            Triggered by: ${{ github.event_name }}
            Commit: ${{ github.sha }}"
            git push
          )