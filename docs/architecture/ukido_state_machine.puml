@startuml ukido_state_machine
!theme blueprint
title Ukido AI Assistant - –î–∏–∞–≥—Ä–∞–º–º–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ v0.7.6

skinparam state {
    BackgroundColor<<social>> #FFFACD
    BackgroundColor<<business>> #E6FFE6
    BackgroundColor<<error>> #FFE6E6
    BackgroundColor<<mixed>> #E6F3FF
    BorderColor Black
    FontSize 12
}

' ===== –ù–ê–ß–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï =====
[*] --> ReceiveMessage: User –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ

state ReceiveMessage {
    note right
        **–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
        ‚Ä¢ user_id
        ‚Ä¢ message
        ‚Ä¢ timestamp
    end note
}

' ===== –ó–ê–ì–†–£–ó–ö–ê –ò–°–¢–û–†–ò–ò =====
ReceiveMessage --> LoadHistory: –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
state LoadHistory {
    note right: –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π\n–¥–ª—è user_id
}

' ===== ROUTER PROCESSING =====
LoadHistory --> RouterAnalysis: –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Gemini Router

state RouterAnalysis {
    state "–ê–Ω–∞–ª–∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è" as Analysis
    state "–î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤" as Decompose
    state "–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ–Ω—Ç–∞" as Intent
    state "Fuzzy matching" as Fuzzy
    
    Analysis --> Decompose: –†–∞–∑–±–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã
    Decompose --> Intent: –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å
    Intent --> Fuzzy: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–µ—á–∞—Ç–∫–∏ (85%)
}

' ===== –ö–õ–ê–°–°–ò–§–ò–ö–ê–¶–ò–Ø =====
RouterAnalysis --> Classification: –†–µ–∑—É–ª—å—Ç–∞—Ç –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏

state Classification <<choice>>

' ===== PURE SOCIAL =====
Classification --> PureSocial: social_score > 0.7\n& no business
state PureSocial <<social>> {
    state "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è" as CheckGreeting
    state "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞" as SocialGen
    
    CheckGreeting --> SocialGen
    note right of CheckGreeting: –ü—Ä–æ–≤–µ—Ä—è–µ–º\n–ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    note right of SocialGen: SocialResponder\n–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç
}

PureSocial --> SaveAndRespond: router_social response

' ===== OFFTOPIC =====
Classification --> Offtopic: offtopic\n& no social
state Offtopic <<error>> {
    note right: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Ñ—Ä–∞–∑–∞:\n"–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —è –º–æ–≥—É\n–æ—Ç–≤–µ—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã\n–æ —à–∫–æ–ª–µ Ukido"
}

Offtopic --> SaveAndRespond: standard response

' ===== NEED SIMPLIFICATION =====
Classification --> NeedSimplification: >3 –≤–æ–ø—Ä–æ—Å–æ–≤
state NeedSimplification <<error>> {
    note right: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–¥–∞–π—Ç–µ\n–Ω–µ –±–æ–ª–µ–µ 3 –≤–æ–ø—Ä–æ—Å–æ–≤\n–æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ"
}

NeedSimplification --> SaveAndRespond: simplification request

' ===== MIXED (Social + Business) =====
Classification --> Mixed: social + business
state Mixed <<mixed>> {
    state "–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π —á–∞—Å—Ç–∏" as MixedSocial
    state "–í—ã–±–æ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤" as MixedDocs
    
    MixedSocial --> MixedDocs
    note right of MixedSocial: –°–æ—Ö—Ä–∞–Ω—è–µ–º\nsocial_context
    note right of MixedDocs: –í—ã–±–∏—Ä–∞–µ–º\n–¥–æ 4 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
}

Mixed --> GenerateResponse

' ===== BUSINESS SUCCESS =====
Classification --> BusinessSuccess: pure business
state BusinessSuccess <<business>> {
    state "–í—ã–±–æ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤" as SelectDocs
    state "–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤" as GroupQuestions
    
    SelectDocs --> GroupQuestions
    note right of SelectDocs: 1-4 –¥–æ–∫—É–º–µ–Ω—Ç–∞\n–ø–æ relevance
    note right of GroupQuestions: –û–±—ä–µ–¥–∏–Ω—è–µ–º\n—Å–≤—è–∑–∞–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã
}

BusinessSuccess --> GenerateResponse

' ===== CLAUDE GENERATION =====
state GenerateResponse {
    state "Claude 3.5 Haiku" as Claude
    state "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏" as CheckHistory
    state "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞" as Generate
    state "–°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è" as Sanitize
    
    CheckHistory --> Generate: –ö–æ–Ω—Ç–µ–∫—Å—Ç –≥–æ—Ç–æ–≤
    Generate --> Sanitize: Raw –æ—Ç–≤–µ—Ç
    
    note right of CheckHistory: –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ\n–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –≤ –∏—Å—Ç–æ—Ä–∏–∏
    note right of Generate: ‚Ä¢ 100-150 —Å–ª–æ–≤\n‚Ä¢ –ü–µ—Ä–≤—ã–µ 2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è - –∫–ª—é—á\n‚Ä¢ –°—Ç–∏–ª—å "–æ—Ç —à–∫–æ–ª—ã"
    note right of Sanitize: –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ\n–ø—Ä–æ–±–µ–ª—ã –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
}

GenerateResponse --> SaveAndRespond

' ===== –°–û–•–†–ê–ù–ï–ù–ò–ï –ò –û–¢–í–ï–¢ =====
state SaveAndRespond {
    state "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—é" as SaveHistory
    state "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç" as SendResponse
    
    SaveHistory --> SendResponse
}

SaveAndRespond --> [*]: –ó–∞–≤–µ—Ä—à–µ–Ω–æ

' ===== –ú–ï–¢–†–ò–ö–ò =====
note bottom of RouterAnalysis
    **Gemini 2.5 Flash**
    –í—Ä–µ–º—è: 1-2 —Å–µ–∫
    –°—Ç–æ–∏–º–æ—Å—Ç—å: $0.00003
end note

note bottom of GenerateResponse
    **Claude 3.5 Haiku**
    –í—Ä–µ–º—è: 4-6 —Å–µ–∫
    –°—Ç–æ–∏–º–æ—Å—Ç—å: $0.0012
end note

' ===== –õ–ï–ì–ï–ù–î–ê =====
note as Legend
    **–¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞:**
    üü° –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ –∏–Ω—Ç–µ–Ω—Ç—ã - –±—ã—Å—Ç—Ä–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
    üü¢ –ë–∏–∑–Ω–µ—Å –≤–æ–ø—Ä–æ—Å—ã - –ø–æ–ª–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
    üî¥ –û—à–∏–±–∫–∏/Offtopic - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
    üîµ –°–º–µ—à–∞–Ω–Ω—ã–µ - –≥–∏–±—Ä–∏–¥–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
    
    **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ v0.7.6:**
    ‚Ä¢ –°–æ—Ü–∏–∞–ª–∫–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ (0.00s)
    ‚Ä¢ –ò—Å—Ç–æ—Ä–∏—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ 10 —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
    ‚Ä¢ Fuzzy matching –¥–ª—è –æ–ø–µ—á–∞—Ç–æ–∫
    ‚Ä¢ –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
end note

@enduml