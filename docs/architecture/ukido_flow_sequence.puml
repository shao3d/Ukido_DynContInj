@startuml Ukido AI Assistant - Data Flow Sequence
!theme C4_blue
skinparam backgroundColor #FEFEFE
skinparam shadowing false

title –ü–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –≤ Ukido AI Assistant (v0.7.6)

actor "–†–æ–¥–∏—Ç–µ–ª—å" as User #LightBlue
participant "FastAPI\nServer" as API #Orange
database "History\nManager" as History #LightGreen
participant "Social\nState" as Social #Pink
participant "Gemini\nRouter" as Router #Purple
database "Knowledge\nBase" as KB #Yellow
participant "Claude\nGenerator" as Generator #Cyan

== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ ==
User -> API: POST /chat\n{"message": "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫–∏–µ –∫—É—Ä—Å—ã –µ—Å—Ç—å?"}
activate API #Orange

API -> History: –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10)
activate History #LightGreen
History --> API: conversation_history[]
deactivate History

API -> Social: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Ü–∏–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
activate Social #Pink
Social --> API: greeting_count, last_greeting_time
deactivate Social

== –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Gemini ==
API -> Router: –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å
activate Router #Purple
note right of Router
  –ê–Ω–∞–ª–∏–∑:
  ‚Ä¢ –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ –∏–Ω—Ç–µ–Ω—Ç—ã (–ø–æ—Ä–æ–≥ 0.7)
  ‚Ä¢ –ë–∏–∑–Ω–µ—Å-–≤–æ–ø—Ä–æ—Å—ã
  ‚Ä¢ –°–º–µ—à–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
  ‚Ä¢ –ö–æ–Ω—Ç–µ–∫—Å—Ç—É–∞–ª—å–Ω—ã–µ ("–ê?")
end note

Router -> Router: –î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤
Router -> Router: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π

alt –ß–∏—Å—Ç–∞—è —Å–æ—Ü–∏–∞–ª–∫–∞ (confidence > 0.7)
    Router --> API: {"type": "router_social",\n"response": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! üëã"}
    note over Router: –í—Ä–µ–º—è: ~0.000s\n–°—Ç–æ–∏–º–æ—Å—Ç—å: $0
else Offtopic –±–µ–∑ —Å–æ—Ü–∏–∞–ª–∫–∏
    Router --> API: {"type": "offtopic",\n"standard_response": true}
else Need simplification (>3 –≤–æ–ø—Ä–æ—Å–æ–≤)
    Router --> API: {"type": "need_simplification"}
else Success - –±–∏–∑–Ω–µ—Å –≤–æ–ø—Ä–æ—Å
    Router -> KB: –ü–æ–¥–±–æ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    activate KB #Yellow
    note right of KB
      –ê–ª–≥–æ—Ä–∏—Ç–º:
      ‚Ä¢ 1 –≤–æ–ø—Ä–æ—Å ‚Üí 1-2 –¥–æ–∫
      ‚Ä¢ 2 –≤–æ–ø—Ä–æ—Å–∞ ‚Üí 2-4 –¥–æ–∫
      ‚Ä¢ 3+ –≤–æ–ø—Ä–æ—Å–æ–≤ ‚Üí max 4
      ‚Ä¢ Fuzzy matching 85%
    end note
    KB --> Router: relevant_documents[]
    deactivate KB
    
    Router --> API: {"type": "success",\n"documents": [...],\n"social_context": {...}}
    note over Router: –í—Ä–µ–º—è: 1.0-2.2s\n–°—Ç–æ–∏–º–æ—Å—Ç—å: $0.00003
end

deactivate Router

== –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ (–µ—Å–ª–∏ success) ==
alt type == "success"
    API -> Generator: –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç
    activate Generator #Cyan
    
    Generator -> Generator: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏\n–Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
    Generator -> KB: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã
    activate KB #Yellow
    KB --> Generator: context_data
    deactivate KB
    
    Generator -> Generator: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞:
    note right of Generator
      ‚Ä¢ –ü–µ—Ä–≤—ã–µ 2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è -
        –∫–ª—é—á–µ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
      ‚Ä¢ 100-150 —Å–ª–æ–≤
      ‚Ä¢ –°—Ç–∏–ª—å "–º—ã"
      ‚Ä¢ –≠–º–ø–∞—Ç–∏—è –¥–ª—è —Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–Ω—ã—Ö
    end note
    
    Generator --> API: final_response
    note over Generator: –í—Ä–µ–º—è: 4.7-6.6s\n–°—Ç–æ–∏–º–æ—Å—Ç—å: $0.0003
    deactivate Generator
end

== –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –æ—Ç–≤–µ—Ç ==
API -> History: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±–º–µ–Ω
activate History #LightGreen
History --> API: saved
deactivate History

API -> Social: –û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
activate Social #Pink
Social --> API: updated
deactivate Social

API --> User: 200 OK\n{"response": "..."}
note over API: –û–±—â–µ–µ –≤—Ä–µ–º—è: 5-7 —Å–µ–∫\n–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: ~$0.0015
deactivate API

== –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ ==
group –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
    API ->x Router: Timeout/Error
    API --> User: Fallback response
end

group –ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π —Ä–æ–¥–∏—Ç–µ–ª—å
    note over Router: –ú–∞—Ç –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è,\n—Ñ–æ–∫—É—Å –Ω–∞ –≤–æ–ø—Ä–æ—Å–µ
    Router -> Generator: with context: "irritated_parent"
    Generator --> API: –≠–º–ø–∞—Ç–∏—á–Ω—ã–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
end

group –ö–æ–Ω—Ç–µ–∫—Å—Ç—É–∞–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å ("–ê?")
    Router -> Router: –†–∞—Å—à–∏—Ä–∏—Ç—å –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏—Å—Ç–æ—Ä–∏–∏
    note over Router: "–ê?" ‚Üí "–ê –∫–∞–∫–∞—è —Ü–µ–Ω–∞ –Ω–∞ –∫—É—Ä—Å –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç?"
end

@enduml