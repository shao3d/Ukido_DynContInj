# Requirements: Dynamic Context Injection для Ukido Bot

## 1. Цель системы

Создать интеллектуальную систему выбора релевантного контекста для AI-ассистента детской онлайн-школы Ukido, которая:
- **Экономит ресурсы**: Вместо загрузки всех 13 документов школы (>100К токенов) в каждый запрос, система выбирает только 1-2 релевантных документа
- **Повышает качество ответов**: Фокусированный контекст позволяет GPT давать более точные и релевантные ответы
- **Ускоряет время ответа**: Меньше токенов = быстрее обработка = лучше UX
- **Снижает затраты**: Меньше токенов = дешевле использование API

## 2. Основные функциональные требования

### 2.1 Приём и обработка запросов
- Система должна принимать HTTP POST запросы от Pipedream
- Система должна валидировать входящие данные на соответствие формату
- Система должна обрабатывать ошибки и возвращать понятные сообщения об ошибках

### 2.2 Анализ и классификация запросов
- Система должна определять намерение (intent) пользователя из текста сообщения
- Система должна классифицировать запросы по категориям:
  - Вопросы о курсах и программах
  - Вопросы о ценах и условиях
  - Вопросы о преподавателях
  - Вопросы о методике обучения
  - Вопросы о результатах и достижениях
  - Общие вопросы о школе
  - Технические вопросы
  - Off-topic запросы

### 2.3 Выбор релевантных документов
- Система должна выбирать 1-2 наиболее релевантных документа из 13 доступных
- Система должна использовать саммари документов для быстрого выбора
- Система должна учитывать confidence score при выборе документов
- При неопределённости система должна выбирать наиболее общие документы (faq.md, courses_detailed.md)

### 2.4 Генерация ответов
- Система должна формировать промпт с выбранными документами в контексте
- Система должна генерировать ответ, используя google/gemini-2.5-flash через OpenRouter API
- Система должна следовать tone of voice школы Ukido (дружелюбный, профессиональный, заботливый)
- Система должна запрашивать уточнения при неясных вопросах (offtopic)

## 3. Входные данные (API Request)

```json
{
    "user_id": "string",        // Уникальный ID пользователя
    "message": "string",        // Текст сообщения от пользователя
    "user_name": "string",      // Имя пользователя
    "metadata": {
        "platform": "string",   // Платформа (telegram, whatsapp, etc.)
        "timestamp": "string"   // ISO 8601 timestamp
    }
}
```

## 4. Выходные данные (API Response)

```json
{
  "response": "string",              // Сгенерированный ответ для пользователя
  "relevant_documents": ["string"],  // Массив использованных документов
  "intent": "string",                // Определённый статус роутера
  "confidence": 1.0                   // Значение по умолчанию для совместимости
}
```

## 5. Нефункциональные требования

### 5.1 Производительность
- Время ответа API: не более 3 секунд (95 percentile)
- Поддержка до 100 одновременных запросов
- Время холодного старта: не более 5 секунд

### 5.2 Надёжность
- Uptime: 99.5% 
- Graceful degradation: при недоступности OpenRouter возвращать заранее подготовленный ответ
- Retry логика для внешних API вызовов

### 5.3 Безопасность
- Валидация всех входящих данных
- Санитизация пользовательского ввода перед отправкой в LLM
- Безопасное хранение API ключей в environment variables
- Rate limiting: максимум 10 запросов в минуту от одного user_id

### 5.4 Масштабируемость
- Stateless архитектура для горизонтального масштабирования
- Кеширование саммари документов в памяти
- Возможность добавления новых документов без изменения кода

### 5.5 Мониторинг
- Логирование всех запросов и ответов
- Метрики: latency, error rate, выбранные документы
- Алерты при превышении error rate > 5%

## 6. Ограничения системы

### 6.1 Технические ограничения
- Максимальный размер сообщения: 1000 символов
- Максимальное количество документов в контексте: 2
- Суммарный размер контекста: не более 8000 токенов
- Используется только google/gemini-2.5-flash

### 6.2 Бизнес-ограничения
- Система отвечает только на вопросы о школе Ukido
- Система не даёт медицинских или психологических советов
- Система не обрабатывает платежи или персональные данные
- Система работает только с текстом (не обрабатывает изображения/аудио)

## 7. База знаний

Система имеет доступ к 13 документам школы Ukido:

1. **courses_detailed.md** - Детальное описание всех курсов
2. **pricing.md** - Цены, скидки, условия оплаты
3. **faq.md** - Часто задаваемые вопросы родителей
4. **methodology.md** - Методика обучения и подходы
5. **teachers_team.md** - Информация о преподавателях
6. **conditions.md** - Условия обучения, расписание, технические требования
7. **results_achievements.md** - Результаты и достижения выпускников
8. **ukido_philosophy.md** - Философия и подход школы
9. **mission_values_history.md** - Миссия, ценности, история создания
10. **parent_involvement_guide.md** - Руководство для родителей
11. **partners.md** - Партнёрства и сотрудничество
12. **roi_and_future_benefits.md** - Окупаемость инвестиций в обучение
13. **safety_and_trust.md** - Безопасность и защита детей

## 8. Критерии успеха

- **Точность выбора документов**: >85% запросов обрабатываются с правильными документами
- **Удовлетворённость пользователей**: >90% позитивных взаимодействий
- **Скорость ответа**: 95% запросов обрабатываются менее чем за 3 секунды
- **Экономия токенов**: Снижение использования токенов на 70% по сравнению с full-context подходом

## 9. Этапы внедрения

1. **MVP**: Базовая функциональность с простым keyword-based роутером
2. **v1.0**: LLM-based роутер с саммари документов
3. **v1.1**: Добавление кеширования и оптимизация производительности
4. **v2.0**: Мультиязычная поддержка и расширенная аналитика

---

*Документ версии 1.0*  
*Дата создания: 2024-08-05*