# üé≠ –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —é–º–æ—Ä–∞ –ñ–≤–∞–Ω–µ—Ü–∫–æ–≥–æ –≤ Ukido AI Assistant

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ
1. [–ö–æ–Ω—Ü–µ–ø—Ü–∏—è](#–∫–æ–Ω—Ü–µ–ø—Ü–∏—è)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—Ä–µ—à–µ–Ω–∏—è)
3. [–î–µ—Ç–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è](#–¥–µ—Ç–∞–ª—å–Ω–∞—è-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
4. [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å](#–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å-–∏-–∫–æ–Ω—Ç—Ä–æ–ª—å)
5. [–ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥](#–º–µ—Ç—Ä–∏–∫–∏-–∏-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)
6. [–ü–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è](#–ø–ª–∞–Ω-–≤–Ω–µ–¥—Ä–µ–Ω–∏—è)

## üéØ –ö–æ–Ω—Ü–µ–ø—Ü–∏—è

### –§–∏–ª–æ—Å–æ—Ñ–∏—è –ø–æ–¥—Ö–æ–¥–∞
–Æ–º–æ—Ä –ñ–≤–∞–Ω–µ—Ü–∫–æ–≥–æ - —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ —à—É—Ç–∫–∏, –∞ **–æ—Å–æ–±—ã–π —Å—Ç–∏–ª—å –º—ã—à–ª–µ–Ω–∏—è** —Å –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–º–∏ –ø–æ–≤–æ—Ä–æ—Ç–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞—Å—Ç–∞–≤–ª—è—é—Ç —É–ª—ã–±–Ω—É—Ç—å—Å—è –∏ –∑–∞–¥—É–º–∞—Ç—å—Å—è. –î–ª—è —à–∫–æ–ª—ã soft skills —ç—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞–≤—ã–∫–∞ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –º—ã—à–ª–µ–Ω–∏—è.

### –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã
- **–†–µ–¥–∫–æ—Å—Ç—å** - –º–∞–∫—Å–∏–º—É–º 10% –æ—Ç offtopic –∑–∞–ø—Ä–æ—Å–æ–≤
- **–£–º–µ—Å—Ç–Ω–æ—Å—Ç—å** - —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–æ–∑–∏—Ç–∏–≤–Ω–æ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - —Ç—Ä—ë—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
- **–û—Ä–≥–∞–Ω–∏—á–Ω–æ—Å—Ç—å** - —Å–≤—è–∑—å —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –¥–∏–∞–ª–æ–≥–∞
- **–≠–∫–æ–Ω–æ–º–∏—á–Ω–æ—Å—Ç—å** - 80%+ –∏–∑ –∫—ç—à–∞ –ø–æ—Å–ª–µ –º–µ—Å—è—Ü–∞

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

### –í—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π —Ñ–ª–æ—É
```
User Message
    ‚Üì
Gemini Router ‚Üí offtopic
    ‚Üì
main.py: –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏–π
    ‚Üì
[mood_ok + topic_safe + 10% random + not_used]
    ‚Üì
ZhvanetskyAI: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞
    ‚Üì
–ö—ç—à miss ‚Üí Claude Haiku –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
–ö—ç—à hit ‚Üí –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –∫–æ–Ω—Ç–µ–∫—Å—Ç
    ‚Üì
–û—Ç–≤–µ—Ç —Å —é–º–æ—Ä–æ–º
```

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

```
src/zhvanetsky/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ zhvanetsky_ai.py      # –û—Å–Ω–æ–≤–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
‚îú‚îÄ‚îÄ humor_cache.py        # –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –∫—ç—à
‚îú‚îÄ‚îÄ safety_checker.py     # –ü—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
‚îî‚îÄ‚îÄ humor_tracker.py      # –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
```

## üíª –î–µ—Ç–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. zhvanetsky_ai.py - –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —é–º–æ—Ä–∞

```python
class ZhvanetskyAI:
    def __init__(self, client):
        self.client = client  # Claude Haiku –∫–ª–∏–µ–Ω—Ç
        self.cache = HumorCache()
        self.prompt_template = """
–¢—ã - –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –¥–µ—Ç—Å–∫–æ–π —à–∫–æ–ª—ã soft skills Ukido. 
–†–æ–¥–∏—Ç–µ–ª—å —Å–ø—Ä–æ—Å–∏–ª –Ω–µ –ø–æ —Ç–µ–º–µ: "{message}"

–û—Ç–≤–µ—Ç—å –û–î–ù–û–ô —Ñ—Ä–∞–∑–æ–π –≤ —Å—Ç–∏–ª–µ –ú–∏—Ö–∞–∏–ª–∞ –ñ–≤–∞–Ω–µ—Ü–∫–æ–≥–æ:
- –ú—è–≥–∫–∞—è –∏—Ä–æ–Ω–∏—è —Å –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–º –ø–æ–≤–æ—Ä–æ—Ç–æ–º
- –°–≤—è–∑—å —Å –ø–æ–ª—å–∑–æ–π –Ω–∞—à–µ–π —à–∫–æ–ª—ã –≤ –∫–æ–Ω—Ü–µ
- –î–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–π —Ç–æ–Ω

–ü—Ä–∏–º–µ—Ä—ã —Å—Ç–∏–ª—è:
- "–§—É—Ç–±–æ–ª? –£ –Ω–∞—Å —Ç–æ–∂–µ –∫–æ–º–∞–Ω–¥–Ω–∞—è –∏–≥—Ä–∞, —Ç–æ–ª—å–∫–æ –º—è—á - —ç—Ç–æ –∏–¥–µ–∏"
- "–ü—Ä–æ–±–∫–∏? –ó–Ω–∞—é —Å–ø–æ—Å–æ–± - –ø–æ–∫–∞ —Å—Ç–æ–∏—Ç–µ, —Ä–µ–±—ë–Ω–æ–∫ —Ä–∞–∑–≤–∏–≤–∞–µ—Ç—Å—è"

–û—Ç–≤–µ—Ç:"""
    
    async def generate_humor(self, message: str, context: dict) -> str:
        # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
        cache_key = self.cache.get_semantic_key(message)
        if cached := self.cache.find_similar(cache_key):
            return self.cache.adapt_cached(cached, message)
        
        # 2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—É—é —à—É—Ç–∫—É
        prompt = self.prompt_template.format(
            message=message,
            mood=context.get("mood", "friendly")
        )
        
        response = await self.client.generate(
            prompt=prompt,
            max_tokens=150,
            temperature=0.7
        )
        
        # 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
        if self.validate_response(response):
            self.cache.save(cache_key, response, context)
            return response
        
        return None  # Fallback –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π offtopic
```

### 2. humor_cache.py - –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∫—ç—à

```python
class HumorCache:
    def __init__(self, max_size=500):
        self.cache = OrderedDict()  # LRU-–ø–æ–¥–æ–±–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
        self.max_size = max_size
        self.hit_count = 0
        self.miss_count = 0
    
    def get_semantic_key(self, message: str) -> str:
        """–°–æ–∑–¥–∞—ë—Ç —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –∫–ª—é—á –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è"""
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏ —Ç–µ–º—É
        topic = self.extract_topic(message)
        keywords = self.extract_keywords(message)
        return f"{topic}:{':'.join(sorted(keywords))}"
    
    def find_similar(self, key: str) -> Optional[dict]:
        """–ò—â–µ—Ç –ø–æ—Ö–æ–∂—É—é —à—É—Ç–∫—É –≤ –∫—ç—à–µ"""
        if key in self.cache:
            self.hit_count += 1
            return self.cache[key]
        
        # Fuzzy matching –¥–ª—è –ø–æ—Ö–æ–∂–∏—Ö –∫–ª—é—á–µ–π
        for cached_key, value in self.cache.items():
            if self.semantic_similarity(key, cached_key) > 0.8:
                self.hit_count += 1
                return value
        
        self.miss_count += 1
        return None
    
    def adapt_cached(self, cached: dict, new_message: str) -> str:
        """–ê–¥–∞–ø—Ç–∏—Ä—É–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—É—é —à—É—Ç–∫—É –ø–æ–¥ –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç"""
        base_joke = cached["response"]
        
        # –ü—Ä–æ—Å—Ç–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è - –∑–∞–º–µ–Ω–∞ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
        old_keywords = cached["keywords"]
        new_keywords = self.extract_keywords(new_message)
        
        adapted = base_joke
        for old, new in zip(old_keywords, new_keywords):
            if old != new and old in adapted:
                adapted = adapted.replace(old, new)
        
        return adapted
```

### 3. safety_checker.py - –°–∏—Å—Ç–µ–º–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

```python
class SafetyChecker:
    # –ù–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Ç–µ–º—ã –¥–ª—è —é–º–æ—Ä–∞
    UNSAFE_TOPICS = [
        "–±–æ–ª–µ–∑–Ω—å", "–±–æ–ª–µ–µ—Ç", "–±–æ–ª—å–Ω–∏—Ü–∞", "–≤—Ä–∞—á", "–ª–µ—á–µ–Ω–∏–µ",
        "—É–º–µ—Ä", "–ø–æ–≥–∏–±", "–∞–≤–∞—Ä–∏—è", "–∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∞", "–±–µ–¥–∞",
        "–ø—Ä–æ–±–ª–µ–º–∞", "–∫—Ä–∏–∑–∏—Å", "–ø–ª–æ—Ö–æ", "—É–∂–∞—Å–Ω–æ",
        "–Ω–µ—Ç –¥–µ–Ω–µ–≥", "–±–∞–Ω–∫—Ä–æ—Ç", "–¥–æ–ª–≥–∏", "—Ä–∞–∑–≤–æ–¥"
    ]
    
    # –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
    NEGATIVE_MARKERS = [
        "–¥–æ—Ä–æ–≥–æ", "–æ–±–º–∞–Ω", "–ø–ª–æ—Ö–æ", "—É–∂–∞—Å–Ω–æ", 
        "–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è", "–≤–æ–∑–º—É—Ç–∏—Ç–µ–ª—å–Ω–æ", "—Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω"
    ]
    
    def validate_humor_context(self, user_signal: str, 
                              history: list, 
                              message: str) -> dict:
        """–ü–æ–ª–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è —é–º–æ—Ä–∞"""
        
        result = {
            "safe": True,
            "appropriate": True,
            "mood": "neutral",
            "topic": None,
            "reason": None
        }
        
        # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ user_signal
        if user_signal in ["anxiety_about_child", "price_sensitive"]:
            result["appropriate"] = False
            result["reason"] = f"inappropriate_signal:{user_signal}"
            return result
        
        # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–∞ –Ω–µ–≥–∞—Ç–∏–≤
        mood = self.check_dialogue_mood(history)
        result["mood"] = mood
        
        if mood == "negative":
            result["appropriate"] = False
            result["reason"] = "negative_mood"
            return result
        
        # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Ç–µ–º—ã
        if not self.is_safe_topic(message):
            result["safe"] = False
            result["reason"] = "unsafe_topic"
            return result
        
        # 4. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–º—ã –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        result["topic"] = self.classify_topic(message)
        
        return result
    
    def get_humor_probability(self, user_history: list, 
                            user_signal: str) -> float:
        """–ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —é–º–æ—Ä–∞"""
        base_probability = 0.1  # 10% –±–∞–∑–æ–≤–∞—è
        
        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–ª—è –¥—Ä—É–∂–µ–ª—é–±–Ω—ã—Ö
        if user_signal == "exploring_only":
            base_probability *= 1.2
        
        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –µ—Å–ª–∏ –±—ã–ª–∏ –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–µ —Ä–µ–∞–∫—Ü–∏–∏
        positive_count = sum(1 for msg in user_history 
                           if any(word in msg.lower() 
                                 for word in ["—Å–ø–∞—Å–∏–±–æ", "–æ—Ç–ª–∏—á–Ω–æ", "–∑–¥–æ—Ä–æ–≤–æ"]))
        
        if positive_count >= 2:
            base_probability *= 1.5
        
        return min(base_probability, 0.15)  # –ú–∞–∫—Å–∏–º—É–º 15%
```

### 4. humor_tracker.py - –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```python
class HumorTracker:
    def __init__(self):
        self.usage = {}  # user_id -> usage_data
        self.global_stats = {
            "total_shown": 0,
            "total_successful": 0,
            "topics": defaultdict(int)
        }
    
    def was_used(self, user_id: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        return user_id in self.usage
    
    def mark_used(self, user_id: str, topic: str = None):
        """–û—Ç–º–µ—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è"""
        self.usage[user_id] = {
            "timestamp": datetime.now(),
            "topic": topic,
            "success": None  # –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ —Å–ª–µ–¥—É—é—â–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
        }
        self.global_stats["total_shown"] += 1
        if topic:
            self.global_stats["topics"][topic] += 1
    
    def update_success(self, user_id: str, continued: bool):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ (–ø—Ä–æ–¥–æ–ª–∂–∏–ª –ª–∏ –¥–∏–∞–ª–æ–≥)"""
        if user_id in self.usage:
            self.usage[user_id]["success"] = continued
            if continued:
                self.global_stats["total_successful"] += 1
    
    def get_success_rate(self) -> float:
        """–û–±—â–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏"""
        if self.global_stats["total_shown"] == 0:
            return 0.0
        return self.global_stats["total_successful"] / self.global_stats["total_shown"]
```

### 5. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ main.py

```python
# main.py - –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 177

# –ò–º–ø–æ—Ä—Ç—ã –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞
from zhvanetsky import ZhvanetskyAI, SafetyChecker, HumorTracker

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 50
if config.HUMOR_ENABLED:
    zhvanetsky_ai = ZhvanetskyAI(
        client=OpenRouterClient(
            api_key=config.OPENROUTER_API_KEY,
            model="anthropic/claude-3-haiku"  # –î–µ—à–µ–≤–ª–µ –¥–ª—è —é–º–æ—Ä–∞
        )
    )
    safety_checker = SafetyChecker()
    humor_tracker = HumorTracker()

# –í –±–ª–æ–∫–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ offtopic (—Å—Ç—Ä–æ–∫–∞ ~177)
if result["intent"] == "offtopic":
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —é–º–æ—Ä–∞
    if config.HUMOR_ENABLED and not humor_tracker.was_used(request.user_id):
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        humor_context = safety_checker.validate_humor_context(
            user_signal=result.get("user_signal", "exploring_only"),
            history=history_list,
            message=request.message
        )
        
        if humor_context["safe"] and humor_context["appropriate"]:
            # –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å
            probability = safety_checker.get_humor_probability(
                user_history=history_list,
                user_signal=result.get("user_signal")
            )
            
            if random.random() < probability:
                # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —é–º–æ—Ä
                try:
                    humor_response = await zhvanetsky_ai.generate_humor(
                        message=request.message,
                        context=humor_context
                    )
                    
                    if humor_response:
                        # –û—Ç–º–µ—á–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
                        humor_tracker.mark_used(
                            request.user_id, 
                            humor_context["topic"]
                        )
                        
                        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
                        logger.info(
                            f"üé≠ Humor: user={request.user_id}, "
                            f"topic={humor_context['topic']}, "
                            f"mood={humor_context['mood']}"
                        )
                        
                        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
                        return JSONResponse({
                            "response": humor_response,
                            "intent": "offtopic",
                            "humor_used": True,
                            "confidence": result.get("confidence", 1.0)
                        })
                        
                except Exception as e:
                    logger.error(f"Humor generation failed: {e}")
    
    # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π offtopic –µ—Å–ª–∏ —é–º–æ—Ä –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω
    response_text = standard_responses.get_offtopic_response()
```

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å

### –¢—Ä—ë—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä–æ–∫

#### –£—Ä–æ–≤–µ–Ω—å 1: User Signal
- ‚ùå `anxiety_about_child` - –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —à—É—Ç–∏–º
- ‚ùå `price_sensitive` - –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —à—É—Ç–∏–º  
- ‚úÖ `exploring_only` - –º–æ–∂–Ω–æ, –¥–∞–∂–µ —á—É—Ç—å —á–∞—â–µ
- ‚úÖ `ready_to_buy` - –º–æ–∂–Ω–æ, –Ω–æ —Ä–µ–¥–∫–æ

#### –£—Ä–æ–≤–µ–Ω—å 2: Dialogue Mood
- –ê–Ω–∞–ª–∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 3 —Å–æ–æ–±—â–µ–Ω–∏–π
- –ü–æ–∏—Å–∫ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—â–µ–π —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

#### –£—Ä–æ–≤–µ–Ω—å 3: Topic Safety
- Blacklist –æ–ø–∞—Å–Ω—ã—Ö —Ç–µ–º
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —É–ø–æ–º–∏–Ω–∞–Ω–∏–π
- –í–∞–ª–∏–¥–∞—Ü–∏—è —É–º–µ—Å—Ç–Ω–æ—Å—Ç–∏

### Fallback —Å—Ç—Ä–∞—Ç–µ–≥–∏—è
–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫:
1. –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
2. –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π offtopic
3. –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–ª–æ—É

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏

```python
# –î–æ–±–∞–≤–∏—Ç—å –≤ /metrics endpoint
"humor_metrics": {
    "enabled": config.HUMOR_ENABLED,
    "total_shown": humor_tracker.global_stats["total_shown"],
    "success_rate": humor_tracker.get_success_rate(),
    "cache_hit_rate": zhvanetsky_ai.cache.get_hit_rate(),
    "topics": humor_tracker.global_stats["topics"],
    "avg_generation_time": zhvanetsky_ai.avg_generation_time
}
```

### A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```python
# –ú–æ–∂–Ω–æ –≤–∫–ª—é—á–∞—Ç—å –¥–ª—è —á–∞—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
def should_enable_humor(user_id: str) -> bool:
    # –ù–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è 50% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    return hash(user_id) % 2 == 0
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ö–∞–∂–¥–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —é–º–æ—Ä–∞
- –ü—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–∞–∑–∞ –æ—Ç —é–º–æ—Ä–∞
- –û—à–∏–±–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- –ú–µ—Ç—Ä–∏–∫–∏ –∫—ç—à–∞

## üìÖ –ü–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### –§–∞–∑–∞ 1: MVP (4-6 —á–∞—Å–æ–≤)
1. **–°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã** (1 —á–∞—Å)
   - –§–∞–π–ª—ã zhvanetsky/*.py
   - –ë–∞–∑–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã

2. **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è SafetyChecker** (1 —á–∞—Å)
   - –ü—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
   - –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å

3. **–ü—Ä–æ—Å—Ç–æ–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä** (1 —á–∞—Å)
   - –ü—Ä–æ–º–ø—Ç –¥–ª—è Claude Haiku
   - –ë–∞–∑–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è

4. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ main.py** (1 —á–∞—Å)
   - –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤ offtopic –±–ª–æ–∫
   - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

5. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** (2 —á–∞—Å–∞)
   - Unit —Ç–µ—Å—Ç—ã
   - –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –§–∞–∑–∞ 2: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (2-3 —á–∞—Å–∞)
1. **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫—ç—à–∞** (1 —á–∞—Å)
   - –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–µ –∫–ª—é—á–∏
   - –ê–¥–∞–ø—Ç–∞—Ü–∏—è —à—É—Ç–æ–∫

2. **–ú–µ—Ç—Ä–∏–∫–∏** (30 –º–∏–Ω)
   - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ /metrics
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

3. **–¢–æ–Ω–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞** (1.5 —á–∞—Å–∞)
   - –£–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π

### –§–∞–∑–∞ 3: Production (2 —á–∞—Å–∞)
1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** (1 —á–∞—Å)
   - Dashboard –º–µ—Ç—Ä–∏–∫
   - –ê–ª–µ—Ä—Ç—ã

2. **A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** (1 —á–∞—Å)
   - –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - –°–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

## üéØ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ MVP

1. **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å**
   - ‚úÖ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —é–º–æ—Ä –¥–ª—è offtopic
   - ‚úÖ –ù–µ –ª–æ–º–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π pipeline
   - ‚úÖ –ú–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –æ–¥–Ω–∏–º —Ñ–ª–∞–≥–æ–º

2. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**
   - ‚úÖ 0 –Ω–µ—É–º–µ—Å—Ç–Ω—ã—Ö —à—É—Ç–æ–∫
   - ‚úÖ –ù–µ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –Ω–µ–≥–∞—Ç–∏–≤–µ
   - ‚úÖ Fallback –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç

3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
   - ‚úÖ <2 —Å–µ–∫ –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
   - ‚úÖ <$0.001 –∑–∞ —à—É—Ç–∫—É
   - ‚úÖ 50%+ cache hit –ø–æ—Å–ª–µ –Ω–µ–¥–µ–ª–∏

4. **–ö–∞—á–µ—Å—Ç–≤–æ**
   - ‚úÖ –®—É—Ç–∫–∏ –≤ —Å—Ç–∏–ª–µ –ñ–≤–∞–Ω–µ—Ü–∫–æ–≥–æ
   - ‚úÖ –°–≤—è–∑—å —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º —à–∫–æ–ª—ã
   - ‚úÖ –ü–æ–∑–∏—Ç–∏–≤–Ω—ã–µ —Ä–µ–∞–∫—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## üöÄ –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –≤–µ—Ç–∫–∏
git checkout -b feature/zhvanetsky-humor

# –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
mkdir -p src/zhvanetsky
touch src/zhvanetsky/__init__.py
touch src/zhvanetsky/zhvanetsky_ai.py
touch src/zhvanetsky/humor_cache.py
touch src/zhvanetsky/safety_checker.py
touch src/zhvanetsky/humor_tracker.py

# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤
mkdir -p tests/unit/zhvanetsky
touch tests/unit/zhvanetsky/test_safety_checker.py
touch tests/unit/zhvanetsky/test_humor_cache.py

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
python -m pytest tests/unit/zhvanetsky/ -v
```

## üìù –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è Claude Haiku

### –ë–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç
```
–¢—ã –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –¥–µ—Ç—Å–∫–æ–π —à–∫–æ–ª—ã soft skills Ukido.
–†–æ–¥–∏—Ç–µ–ª—å —Å–ø—Ä–æ—Å–∏–ª –ø—Ä–æ {topic}: "{message}"

–û—Ç–≤–µ—Ç—å –æ–¥–Ω–æ–π —Ñ—Ä–∞–∑–æ–π –≤ —Å—Ç–∏–ª–µ –ñ–≤–∞–Ω–µ—Ü–∫–æ–≥–æ - —Å –º—è–≥–∫–æ–π –∏—Ä–æ–Ω–∏–µ–π –∏ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–º –ø–æ–≤–æ—Ä–æ—Ç–æ–º, —Å–≤—è–∑–∞–≤ —Å –ø–æ–ª—å–∑–æ–π –Ω–∞—à–µ–π —à–∫–æ–ª—ã.

–ü—Ä–∏–º–µ—Ä: "–§—É—Ç–±–æ–ª? –£ –Ω–∞—Å —Ç–æ–∂–µ 22 —á–µ–ª–æ–≤–µ–∫–∞ –±–µ–≥–∞—é—Ç - —Ç–æ–ª—å–∫–æ –∑–∞ –∑–Ω–∞–Ω–∏—è–º–∏, –∏ –Ω–∏–∫—Ç–æ –Ω–µ –ø—Ä–æ–º–∞—Ö–∏–≤–∞–µ—Ç—Å—è –º–∏–º–æ –±—É–¥—É—â–µ–≥–æ."

–¢–≤–æ–π –æ—Ç–≤–µ—Ç:
```

### –ü—Ä–æ–º–ø—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
```
–ö–æ–Ω—Ç–µ–∫—Å—Ç: —Ä–æ–¥–∏—Ç–µ–ª—å –≤ —Ö–æ—Ä–æ—à–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏, –∏–∑—É—á–∞–µ—Ç —à–∫–æ–ª—É
–¢–µ–º–∞ –≤–æ–ø—Ä–æ—Å–∞: {topic}
–í–æ–ø—Ä–æ—Å: "{message}"

–°–æ–∑–¥–∞–π –¥—Ä—É–∂–µ–ª—é–±–Ω—É—é —à—É—Ç–∫—É –≤ —Å—Ç–∏–ª–µ –ñ–≤–∞–Ω–µ—Ü–∫–æ–≥–æ (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è), –∫–æ—Ç–æ—Ä–∞—è:
1. –û—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å —Å —é–º–æ—Ä–æ–º
2. –ü–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç –∫ –ø–æ–ª—å–∑–µ –Ω–∞—à–∏—Ö –∫—É—Ä—Å–æ–≤
3. –ù–µ –æ–±–∏–∂–∞–µ—Ç –∏ –Ω–µ –≤—ã—Å–º–µ–∏–≤–∞–µ—Ç

–û—Ç–≤–µ—Ç:
```

## üîÑ –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –∏ –∏—Ç–µ—Ä–∞—Ü–∏–∏

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ —Å–æ–±–∏—Ä–∞–µ–º:
1. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π
2. –†–µ–∞–∫—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç –ª–∏ –¥–∏–∞–ª–æ–≥)
3. –ö–∞–∫–∏–µ —Ç–µ–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç –ª—É—á—à–µ
4. –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å

–ù–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö:
- –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç—ã
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏
- –†–∞—Å—à–∏—Ä—è–µ–º/—Å—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ç–µ–º
- –£–ª—É—á—à–∞–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

---

**–î–æ–∫—É–º–µ–Ω—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω**: 21.08.2025
**–í–µ—Ä—Å–∏—è**: 1.0
**–î–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤**: v0.13.0