sequenceDiagram
    title Ukido AI Assistant - Request Processing Flow (v0.7.6)
    
    participant U as üë§ –†–æ–¥–∏—Ç–µ–ª—å
    participant API as FastAPI Server
    participant H as History Manager
    participant S as Social State
    participant R as Gemini Router
    participant KB as Knowledge Base
    participant G as Claude Generator
    
    %% –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞
    U->>+API: POST /chat<br/>{"message": "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫–∏–µ –∫—É—Ä—Å—ã?"}
    
    API->>H: –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10)
    H-->>API: conversation_history[]
    
    API->>S: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Ü–∏–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    S-->>API: greeting_count, last_greeting_time
    
    %% –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è
    API->>+R: –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å
    Note over R: –ê–Ω–∞–ª–∏–∑:<br/>‚Ä¢ –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ –∏–Ω—Ç–µ–Ω—Ç—ã (0.7)<br/>‚Ä¢ –ë–∏–∑–Ω–µ—Å-–≤–æ–ø—Ä–æ—Å—ã<br/>‚Ä¢ –ö–æ–Ω—Ç–µ–∫—Å—Ç—É–∞–ª—å–Ω—ã–µ ("–ê?")
    
    R->>R: –î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤
    R->>R: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–≤—Ç–æ—Ä–æ–≤
    
    alt –ß–∏—Å—Ç–∞—è —Å–æ—Ü–∏–∞–ª–∫–∞ (confidence > 0.7)
        R-->>API: router_social<br/>"–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! üëã"
        Note over R: ‚è±Ô∏è ~0.000s<br/>üí∞ $0
    else –ë–∏–∑–Ω–µ—Å-–≤–æ–ø—Ä–æ—Å (success)
        R->>KB: –ü–æ–¥–±–æ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        Note over KB: –ê–ª–≥–æ—Ä–∏—Ç–º:<br/>‚Ä¢ 1 –≤–æ–ø—Ä–æ—Å ‚Üí 1-2 –¥–æ–∫<br/>‚Ä¢ 2 –≤–æ–ø—Ä–æ—Å–∞ ‚Üí 2-4 –¥–æ–∫<br/>‚Ä¢ 3+ ‚Üí max 4<br/>‚Ä¢ Fuzzy 85%
        KB-->>R: relevant_documents[]
        R-->>-API: success + documents
        Note over R: ‚è±Ô∏è 1.0-2.2s<br/>üí∞ $0.00003
        
        %% –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞
        API->>+G: –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç
        G->>G: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
        G->>KB: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã
        KB-->>G: context_data
        G->>G: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞
        Note over G: –ü—Ä–∞–≤–∏–ª–∞:<br/>‚Ä¢ –ü–µ—Ä–≤—ã–µ 2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è<br/>‚Ä¢ 100-150 —Å–ª–æ–≤<br/>‚Ä¢ –°—Ç–∏–ª—å "–º—ã"<br/>‚Ä¢ –≠–º–ø–∞—Ç–∏—è
        G-->>-API: final_response
        Note over G: ‚è±Ô∏è 4.7-6.6s<br/>üí∞ $0.0003
    else Offtopic
        R-->>API: standard_response
    end
    
    %% –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –æ—Ç–≤–µ—Ç
    API->>H: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±–º–µ–Ω
    H-->>API: saved
    
    API->>S: –û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    S-->>API: updated
    
    API-->>-U: 200 OK<br/>{"response": "..."}
    Note over API: üìä –ú–µ—Ç—Ä–∏–∫–∏:<br/>‚è±Ô∏è –û–±—â–µ–µ: 5-7 —Å–µ–∫<br/>üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: ~$0.0015