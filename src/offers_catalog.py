"""
offers_catalog.py - Каталог персонализированных предложений для State Machine
Версия 1.1: MVP с улучшенной вариативностью CTA
"""

import random  # Добавляем для лучшей случайности выбора

# Каталог предложений для каждого user_signal
OFFERS_CATALOG = {
    "price_sensitive": {
        "text": "Кстати, у нас действуют скидки: 10% при полной оплате курса, 15% для второго ребенка из семьи, и 20% для семей в сложной жизненной ситуации.",
        "text_variants": [
            "Кстати, у нас действуют скидки: 10% при полной оплате курса, 15% для второго ребенка из семьи.",
            "Доступна рассрочка без процентов на 3 месяца. Также есть семейные скидки до 20%.",
            "Напоминаем про финансовые опции: скидка 10% за полную оплату, рассрочка на 3 месяца без переплат.",
            "У нас гибкая система оплаты: скидки до 20%, рассрочка, специальные условия для многодетных семей.",
            "Это инвестиция, которая окупается: навыки soft skills повышают успеваемость и помогают в будущей карьере.",
            "Стоимость сопоставима с 2-3 занятиями репетитора, но эффект остаётся на всю жизнь.",
            "Многие родители говорят, что вложение в soft skills экономит на репетиторах - дети учатся учиться."
        ],
        "priority": "medium",
        "placement": "end"
    },
    "anxiety_about_child": {
        "text": "Первое занятие всегда бесплатное - так вы сможете оценить, подходит ли наш подход вашему ребенку.",
        "text_variants": [
            "Первое занятие полностью бесплатное - ребенок попробует, а вы оцените подходит ли наш метод.",
            "Напоминаем: первая встреча бесплатная, без обязательств. Ребенок сможет попробовать, а вы - оценить.",
            "Кстати, пробное занятие у нас бесплатное. Никакого давления - просто посмотрите, как мы работаем.",
            "У нас есть гарантия: если после первых 3 занятий вы поймёте, что курс не подходит - вернём деньги.",
            "Можем начать с индивидуальной консультации, чтобы обсудить особенности вашего ребёнка.",
            "76% стеснительных детей раскрываются уже на втором занятии благодаря нашей методике."
        ],
        "priority": "high",
        "placement": "end"
    },
    "ready_to_buy": {
        "text_clear": "Запись на пробное занятие открыта. Вот прямая ссылка: ukido.ua/trial. В группах осталось всего несколько мест, рекомендуем не откладывать.",
        "text_unclear": "Что именно вы хотите сделать - записаться на курс или узнать больше информации? Для записи перейдите на ukido.ua/trial или оставьте ваш контакт.",
        "text": "Запись на пробное занятие открыта. Вот прямая ссылка: ukido.ua/trial. В группах осталось всего несколько мест, рекомендуем не откладывать.",
        "text_variants": [
            "Запись на пробное занятие открыта. Переходите по ссылке: ukido.ua/trial. В группах осталось всего несколько мест.",
            "Вы можете записаться прямо сейчас: ukido.ua/trial. Ближайшие занятия начинаются на следующей неделе, места быстро разбирают.",
            "Готовы начать? Переходите на ukido.ua/trial для записи. Можем подобрать удобное время - у нас есть утренние, дневные и вечерние группы.",
            "Отлично! Давайте запишем вас на пробное занятие: ukido.ua/trial. Это займёт буквально 2 минуты, и вы сразу получите подтверждение."
        ],
        "priority": "high",
        "placement": "end_with_urgency"
    },
    "ready_to_buy_repeat": {
        "text": "Менеджер свяжется с вами в течение дня для подтверждения записи. Если есть вопросы - пишите!",
        "priority": "low",
        "placement": "end"
    },
    # Мягкие CTA для exploring_only - очень ненавязчиво
    "exploring_only": {
        "text": "Если появятся вопросы - обращайтесь, всегда рады помочь!",
        "text_variants": [
            "Если появятся вопросы - обращайтесь, всегда рады помочь!",
            "Подробнее о наших программах можно узнать на ukido.ua",
            "Если интересно, первое пробное занятие у нас бесплатное.",
            "Рады были рассказать! Если захотите узнать больше - мы всегда на связи.",
            "Кстати, можем провести бесплатную консультацию по выбору курса для вашего ребёнка."
        ],
        "priority": "low",  # Низкий приоритет для ненавязчивости
        "placement": "end"
    }
}

# Адаптация тона ответа в зависимости от сигнала
TONE_ADAPTATIONS = {
    "price_sensitive": {
        "prefix": "",
        "style": "Подчеркивай ценность и долгосрочную окупаемость инвестиции в развитие ребенка. Упоминай конкретные навыки, которые пригодятся в будущем.",
        "key_phrases": [
            "инвестиция в будущее",
            "навыки на всю жизнь",
            "окупится многократно",
            "доступные варианты оплаты"
        ]
    },
    "anxiety_about_child": {
        "prefix": "Понимаем вашу заботу о ребенке. ",
        "style": "Начинай с эмпатии и понимания. Давай конкретные гарантии безопасности и примеры успеха похожих детей. Подчеркивай индивидуальный подход.",
        "key_phrases": [
            "многие дети приходят с похожими сложностями",
            "безопасная атмосфера",
            "постепенное развитие уверенности",
            "76% детей преодолевают страхи"
        ]
    },
    "ready_to_buy": {
        "prefix": "Отлично, что вы готовы начать! ",
        "style": "Будь конкретным и action-oriented. Давай четкие инструкции, убирай лишние детали. Создавай ощущение urgency без давления.",
        "key_phrases": [
            "простые шаги для записи",
            "ближайшее занятие",
            "места ограничены",
            "можно начать уже на этой неделе"
        ]
    },
    "exploring_only": {
        "prefix": "",
        "style": "Будь информативным и дружелюбным, без навязчивости. Фокусируйся на пользе для ребенка, а не на продаже.",
        "key_phrases": [
            "рады рассказать",
            "наша методика",
            "развитие soft skills",
            "подходит для детей 7-14 лет"
        ]
    }
}

# Динамические примеры для few-shot learning
DYNAMIC_EXAMPLES = {
    "price_sensitive": """
Пример диалога с родителем, чувствительным к цене:
User: Дорого ли у вас обучение?
Assistant: Давайте посмотрим на это как на инвестицию в будущее вашего ребенка. Курс "Юный Оратор" стоит 6000 грн в месяц, но навыки публичных выступлений пригодятся всю жизнь - от школьных презентаций до будущей карьеры. К тому же, у нас есть скидки: 10% при полной оплате курса и 15% для второго ребенка. Эти навыки окупятся многократно, когда ваш ребенок будет уверенно выступать на экзаменах и собеседованиях.
""",
    
    "anxiety_about_child": """
Пример диалога с тревожным родителем:
User: Мой сын очень стеснительный, не знаю, справится ли
Assistant: Понимаем вашу тревогу - многие родители приходят к нам именно с такой проблемой, и мы знаем, как помочь. В наших группах максимум 6 детей, что создает камерную, безопасную атмосферу. Педагоги специально обучены работе со стеснительными детьми и используют методики постепенного вовлечения. 76% наших учеников избавляются от страха публичных выступлений уже через 2 месяца. Начнем с простых упражнений в парах, и ваш сын даже не заметит, как начнет выступать перед всей группой.
""",
    
    "ready_to_buy": """
Пример диалога с готовым к покупке родителем:
User: Хочу записать дочку, что нужно сделать?
Assistant: Отлично, что вы готовы начать! Вот простые шаги: 1) Перейдите по ссылке ukido.ua/trial для записи на бесплатное пробное занятие. 2) Выберите удобное время - у нас есть группы в 17:00 и 19:00. 3) Заполните короткую форму (2 минуты). После пробного занятия вы сможете принять окончательное решение. Ближайшее занятие уже в эту субботу, осталось 3 места в группе.
""",
    
    "exploring_only": """
Пример информативного диалога с украинским родителем-исследователем:
User: Расскажите подробнее о вашей школе, чем именно занимаетесь?
Assistant: Ukido - это школа развития soft skills для детей 7-14 лет. Мы помогаем детям стать увереннее в общении, научиться выступать публично и работать в команде. У нас три основных курса: "Юный Оратор" для развития речи, "Эмоциональный интеллект" для понимания чувств, и "Лидерство" для старших детей. Занятия проходят раз в неделю по 2 часа в мини-группах до 8 человек. Наша методика основана на практике - 80% времени дети активно участвуют в упражнениях и проектах.

User: Какие конкретные навыки получит мой ребенок?
Assistant: Ваш ребенок научится четко выражать мысли, уверенно выступать перед аудиторией и преодолеет страх публичных выступлений. Развивается критическое мышление - дети учатся анализировать информацию и аргументировать позицию. Работа в команде поможет находить общий язык со сверстниками. Эмоциональный интеллект даст понимание своих и чужих эмоций. Эти навыки пригодятся уже сейчас в школе при ответах у доски и презентациях, а в будущем - при поступлении в ВУЗ и построении карьеры.
"""
}

def get_offer(user_signal: str, history: list = None) -> dict:
    """
    Получить предложение для конкретного сигнала
    
    Args:
        user_signal: Определенный сигнал пользователя
        history: История диалога для определения повторных сигналов
        
    Returns:
        Словарь с предложением или None
    """
    # Если это ready_to_buy, проверяем была ли уже ссылка в истории
    if user_signal == "ready_to_buy" and history:
        # Проверяем последние ответы ассистента на наличие ссылки
        for msg in history[-6:]:  # Проверяем последние 3 пары сообщений
            if msg.get("role") == "assistant" and "ukido.ua/trial" in msg.get("content", ""):
                # Ссылка уже была показана, используем облегченный вариант
                return OFFERS_CATALOG.get("ready_to_buy_repeat")
    
    # Получаем базовое предложение
    offer = OFFERS_CATALOG.get(user_signal)
    
    # Обработка вариантов текста для разнообразия
    if offer and "text_variants" in offer and offer["text_variants"]:
        # MVP подход: используем случайный выбор для максимальной вариативности
        offer = offer.copy()  # Создаём копию, чтобы не модифицировать оригинал
        
        # Выбираем случайный вариант
        selected_variant = random.choice(offer["text_variants"])
        offer["text"] = selected_variant
        
        # Логируем для отладки
        variant_index = offer["text_variants"].index(selected_variant)
        print(f"🎲 CTA вариант #{variant_index + 1} из {len(offer['text_variants'])} для {user_signal}")
    
    return offer

def get_tone_adaptation(user_signal: str) -> dict:
    """
    Получить адаптацию тона для сигнала
    
    Args:
        user_signal: Определенный сигнал пользователя
        
    Returns:
        Словарь с параметрами адаптации тона
    """
    return TONE_ADAPTATIONS.get(user_signal, TONE_ADAPTATIONS["exploring_only"])

def get_dynamic_example(user_signal: str) -> str:
    """
    Получить динамический пример для few-shot learning
    
    Args:
        user_signal: Определенный сигнал пользователя
        
    Returns:
        Строка с примером диалога
    """
    return DYNAMIC_EXAMPLES.get(user_signal, "")