"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
–î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç offtopic –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π –æ—Ç–Ω–æ—Å—è—â–∏—Ö—Å—è –∫ —à–∫–æ–ª–µ.
MVP –≤–µ—Ä—Å–∏—è –¥–ª—è Ukido AI Assistant.
"""

import random
from typing import Dict, List, Optional


class CompletedActionsHandler:
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    –î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç offtopic –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π –æ—Ç–Ω–æ—Å—è—â–∏—Ö—Å—è –∫ —à–∫–æ–ª–µ.
    """
    
    def __init__(self):
        # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –¥–µ—Ç–µ–∫—Ü–∏–∏
        self.ACTION_PATTERNS = {
            'payment': {
                'keywords': ['–æ–ø–ª–∞—Ç–∏–ª', '–æ–ø–ª–∞—Ç–∏–ª–∞', '–ø–µ—Ä–µ–≤–µ–ª', '–ø–µ—Ä–µ–≤–µ–ª–∞', 
                            '–æ—Ç–ø—Ä–∞–≤–∏–ª –¥–µ–Ω—å–≥–∏', '–∑–∞–ø–ª–∞—Ç–∏–ª', '–∑–∞–ø–ª–∞—Ç–∏–ª–∞', '–≤–Ω–µ—Å –æ–ø–ª–∞—Ç—É',
                            '–≤–Ω–µ—Å–ª–∞ –æ–ø–ª–∞—Ç—É', '—Å–¥–µ–ª–∞–ª –ø–µ—Ä–µ–≤–æ–¥', '—Å–¥–µ–ª–∞–ª–∞ –ø–µ—Ä–µ–≤–æ–¥'],
                'school_context': ['–∫—É—Ä—Å', '–∑–∞–Ω—è—Ç–∏–µ', '–æ–±—É—á–µ–Ω–∏–µ', '—Å—á–µ—Ç'],
                # –°–ª–æ–≤–∞-–∏—Å–∫–ª—é—á–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ –ù–ï —à–∫–æ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
                'exclusion_words': ['–±–µ–Ω–∑–∏–Ω', '–ø—Ä–æ–¥—É–∫—Ç', '–º–∞–≥–∞–∑–∏–Ω', '–∫–∞—Ñ–µ', '—Ä–µ—Å—Ç–æ—Ä–∞–Ω', 
                                   '—Ç–∞–∫—Å–∏', '–ø–∞—Ä–∫–æ–≤–∫', '—à—Ç—Ä–∞—Ñ', '–∫–æ–º–º—É–Ω–∞–ª'],
                'responses': [
                    "–û—Ç–ª–∏—á–Ω–æ! –û–ø–ª–∞—Ç–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è. –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ —á–∞—Å–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è. –ï—Å—Ç—å –µ—â—ë –≤–æ–ø—Ä–æ—Å—ã?",
                    "–°–ø–∞—Å–∏–±–æ! –ö–∞–∫ —Ç–æ–ª—å–∫–æ –ø–ª–∞—Ç—ë–∂ –ø—Ä–æ–π–¥—ë—Ç (–æ–±—ã—á–Ω–æ –¥–æ 30 –º–∏–Ω—É—Ç), –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞ email. –ß–µ–º –µ—â—ë –º–æ–≥—É –ø–æ–º–æ—á—å?",
                    "–•–æ—Ä–æ—à–æ! –ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã –º–µ–Ω–µ–¥–∂–µ—Ä –æ—Ç–ø—Ä–∞–≤–∏—Ç –≤–∞–º –¥–æ—Å—Ç—É–ø—ã –∫ –∑–∞–Ω—è—Ç–∏—è–º. –ß—Ç–æ –µ—â—ë –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?"
                ],
                'implicit_questions': [
                    "–ö–æ–≥–¥–∞ –±—É–¥–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã?",
                    "–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã?",
                    "–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∑–∞–Ω—è—Ç–∏—è–º?"
                ]
            },
            'registration': {
                'keywords': ['–∑–∞–ø–∏—Å–∞–ª—Å—è', '–∑–∞–ø–∏—Å–∞–ª–∏—Å—å', '–∑–∞–ø–∏—Å–∞–ª–∞—Å—å', '–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª',
                            '–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∞', '–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å', '–ø–æ–¥–∞–ª –∑–∞—è–≤–∫—É', 
                            '–ø–æ–¥–∞–ª–∞ –∑–∞—è–≤–∫—É', '–æ—Ñ–æ—Ä–º–∏–ª –∑–∞–ø–∏—Å—å', '–æ—Ñ–æ—Ä–º–∏–ª–∞ –∑–∞–ø–∏—Å—å'],
                'school_context': ['–∫—É—Ä—Å', '–∑–∞–Ω—è—Ç–∏–µ', '–ø—Ä–æ–±–Ω–æ–µ', '–≥—Ä—É–ø–ø–∞', '–∑–∞–ø–∏—Å'],
                'responses': [
                    "–ü—Ä–µ–∫—Ä–∞—Å–Ω–æ! –í–∞—à–∞ –∑–∞–ø–∏—Å—å –ø—Ä–∏–Ω—è—Ç–∞. –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π. –ö–∞–∫–∏–µ —É –≤–∞—Å –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã?",
                    "–û—Ç–ª–∏—á–Ω–æ! –í—ã –∑–∞–ø–∏—Å–∞–Ω—ã. –ó–∞ –¥–µ–Ω—å –¥–æ –∑–∞–Ω—è—Ç–∏—è –ø—Ä–∏–¥—ë—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å —Å—Å—ã–ª–∫–æ–π –Ω–∞ Zoom. –ß—Ç–æ –µ—â—ë —Ö–æ—Ç–∏—Ç–µ —É–∑–Ω–∞—Ç—å?",
                    "–°—É–ø–µ—Ä! –ó–∞–ø–∏—Å—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞. –í –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è —Å –≤–∞–º–∏ —Å–≤—è–∂–µ—Ç—Å—è –º–µ–Ω–µ–¥–∂–µ—Ä. –ß–µ–º –µ—â—ë –º–æ–≥—É –ø–æ–º–æ—á—å?"
                ],
                'implicit_questions': [
                    "–ö–æ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è –∑–∞–Ω—è—Ç–∏—è?",
                    "–ß—Ç–æ –Ω—É–∂–Ω–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∫ –ø–µ—Ä–≤–æ–º—É –∑–∞–Ω—è—Ç–∏—é?",
                    "–ö–∞–∫ –ø—Ä–æ—Ö–æ–¥—è—Ç –∑–∞–Ω—è—Ç–∏—è?"
                ]
            },
            'form': {
                'keywords': ['–∑–∞–ø–æ–ª–Ω–∏–ª —Ñ–æ—Ä–º—É', '–∑–∞–ø–æ–ª–Ω–∏–ª–∞ —Ñ–æ—Ä–º—É', '–æ—Ç–ø—Ä–∞–≤–∏–ª –∞–Ω–∫–µ—Ç—É', 
                            '–æ—Ç–ø—Ä–∞–≤–∏–ª–∞ –∞–Ω–∫–µ—Ç—É', '–∑–∞–ø–æ–ª–Ω–∏–ª –∑–∞—è–≤–∫—É', '–∑–∞–ø–æ–ª–Ω–∏–ª–∞ –∑–∞—è–≤–∫—É',
                            '–æ—Ñ–æ—Ä–º–∏–ª –∑–∞—è–≤–∫—É', '–æ—Ñ–æ—Ä–º–∏–ª–∞ –∑–∞—è–≤–∫—É', '–∑–∞–ø–æ–ª–Ω–∏–ª –Ω–∞ —Å–∞–π—Ç–µ',
                            '–∑–∞–ø–æ–ª–Ω–∏–ª–∞ –Ω–∞ —Å–∞–π—Ç–µ'],
                'school_context': ['—Å–∞–π—Ç', '—Ñ–æ—Ä–º', '–∞–Ω–∫–µ—Ç', '–∑–∞—è–≤–∫'],
                'responses': [
                    "–°–ø–∞—Å–∏–±–æ! –ú—ã –ø–æ–ª—É—á–∏–ª–∏ –≤–∞—à—É –∑–∞—è–≤–∫—É. –ú–µ–Ω–µ–¥–∂–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –µ—ë –∏ —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è. –ï—Å—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã?",
                    "–û—Ç–ª–∏—á–Ω–æ! –ó–∞—è–≤–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ. –û–±—ã—á–Ω–æ –º—ã –æ—Ç–≤–µ—á–∞–µ–º –≤ —Ç–µ—á–µ–Ω–∏–µ 2-3 —á–∞—Å–æ–≤ –≤ —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è. –ß–µ–º –µ—â—ë –º–æ–≥—É –ø–æ–º–æ—á—å?",
                    "–•–æ—Ä–æ—à–æ! –í–∞—à–∞ —Ñ–æ—Ä–º–∞ –ø–æ–ª—É—á–µ–Ω–∞. –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–∫–æ—Ä–æ —Å –≤–∞–º–∏ —Å–≤—è–∂–µ—Ç—Å—è –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π. –ß—Ç–æ –µ—â—ë –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?"
                ],
                'implicit_questions': [
                    "–ö–æ–≥–¥–∞ —Å–æ –º–Ω–æ–π —Å–≤—è–∂–µ—Ç—Å—è –º–µ–Ω–µ–¥–∂–µ—Ä?",
                    "–ö–∞–∫–∏–µ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏?",
                    "–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ—Å–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º—ã?"
                ]
            },
            'trial': {
                'keywords': ['–±—ã–ª –Ω–∞ –ø—Ä–æ–±–Ω–æ–º', '–±—ã–ª–∞ –Ω–∞ –ø—Ä–æ–±–Ω–æ–º', '–±—ã–ª–∏ –Ω–∞ –ø—Ä–æ–±–Ω–æ–º',
                            '–ø–æ—Å–µ—Ç–∏–ª –ø—Ä–æ–±–Ω–æ–µ', '–ø–æ—Å–µ—Ç–∏–ª–∞ –ø—Ä–æ–±–Ω–æ–µ', '–ø–æ—Å–µ—Ç–∏–ª–∏ –ø—Ä–æ–±–Ω–æ–µ',
                            '–ø—Ä–æ—à–ª–∏ –ø—Ä–æ–±–Ω–æ–µ', '–ø—Ä–æ—à—ë–ª –ø—Ä–æ–±–Ω–æ–µ', '–ø—Ä–æ—à–ª–∞ –ø—Ä–æ–±–Ω–æ–µ',
                            '–∑–∞–∫–æ–Ω—á–∏–ª–∏ –ø—Ä–æ–±–Ω–æ–µ', '–∑–∞–∫–æ–Ω—á–∏–ª –ø—Ä–æ–±–Ω–æ–µ', '–∑–∞–∫–æ–Ω—á–∏–ª–∞ –ø—Ä–æ–±–Ω–æ–µ'],
                'school_context': ['–∑–∞–Ω—è—Ç–∏–µ', '—É—Ä–æ–∫', '–ø—Ä–æ–±–Ω'],
                'responses': [
                    "–ó–¥–æ—Ä–æ–≤–æ! –ù–∞–¥–µ–µ–º—Å—è, –∑–∞–Ω—è—Ç–∏–µ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å. –ì–æ—Ç–æ–≤—ã –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø–æ–ª–Ω—ã–π –∫—É—Ä—Å? –ú–æ–≥—É —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ —Å–∫–∏–¥–∫–∞—Ö –¥–ª—è –Ω–æ–≤—ã—Ö —É—á–µ–Ω–∏–∫–æ–≤.",
                    "–û—Ç–ª–∏—á–Ω–æ! –ö–∞–∫ –≤–∞–º –ø—Ä–æ–±–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ? –ï—Å–ª–∏ –≥–æ—Ç–æ–≤—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å, —É –Ω–∞—Å –µ—Å—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ –ø—Ä–æ—à—ë–ª –ø—Ä–æ–±–Ω—ã–π —É—Ä–æ–∫.",
                    "–°—É–ø–µ—Ä! –†–∞–¥—ã, —á—Ç–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞–ª–∏. –•–æ—Ç–∏—Ç–µ —É–∑–Ω–∞—Ç—å –æ –ø—Ä–æ–≥—Ä–∞–º–º–µ –ø–æ–ª–Ω–æ–≥–æ –∫—É—Ä—Å–∞ –∏–ª–∏ –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã –ø–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∑–∞–Ω—è—Ç–∏–π?"
                ],
                'implicit_questions': [
                    "–ö–∞–∫ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø–æ–ª–Ω—ã–π –∫—É—Ä—Å?",
                    "–ö–∞–∫–∏–µ –µ—Å—Ç—å —Å–∫–∏–¥–∫–∏ –ø–æ—Å–ª–µ –ø—Ä–æ–±–Ω–æ–≥–æ?",
                    "–ö–æ–≥–¥–∞ –º–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ?"
                ]
            },
            'documents': {
                'keywords': ['–æ—Ç–ø—Ä–∞–≤–∏–ª –¥–æ–∫—É–º–µ–Ω—Ç—ã', '–æ—Ç–ø—Ä–∞–≤–∏–ª–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ã', '–ø—Ä–∏—Å–ª–∞–ª –¥–æ–∫—É–º–µ–Ω—Ç—ã',
                            '–ø—Ä–∏—Å–ª–∞–ª–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ã', '–∑–∞–≥—Ä—É–∑–∏–ª –¥–æ–∫—É–º–µ–Ω—Ç—ã', '–∑–∞–≥—Ä—É–∑–∏–ª–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ã',
                            '–≤—ã—Å–ª–∞–ª –¥–æ–∫—É–º–µ–Ω—Ç—ã', '–≤—ã—Å–ª–∞–ª–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ã'],
                'school_context': ['–¥–æ–∫—É–º–µ–Ω—Ç', '—Ñ–∞–π–ª', '—Å–∫–∞–Ω', '–∫–æ–ø–∏'],
                'responses': [
                    "–°–ø–∞—Å–∏–±–æ! –î–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã. –ú–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ–≤–µ—Ä–∏—Ç –∏—Ö –∏ —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏. –ï—Å—Ç—å –µ—â—ë –≤–æ–ø—Ä–æ—Å—ã?",
                    "–û—Ç–ª–∏—á–Ω–æ! –ú—ã –ø–æ–ª—É—á–∏–ª–∏ –≤–∞—à–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–π–º—ë—Ç –¥–æ –æ–¥–Ω–æ–≥–æ —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è. –ß–µ–º –µ—â—ë –º–æ–≥—É –ø–æ–º–æ—á—å?"
                ],
                'implicit_questions': [
                    "–ö–æ–≥–¥–∞ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤?",
                    "–ù—É–∂–Ω—ã –ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã?",
                    "–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤?"
                ]
            }
        }
        
        # –§—Ä–∞–∑—ã –¥–ª—è –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤
        self.UNCERTAIN_RESPONSES = [
            "–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å –¥–∞–ª—å—à–µ?",
            "–•–æ—Ä–æ—à–æ! –ö–∞–∫–∏–µ —É –≤–∞—Å –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã –ø–æ –Ω–∞—à–∏–º –∫—É—Ä—Å–∞–º?",
            "–û—Ç–ª–∏—á–Ω–æ! –ß—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç - —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ, –ø—Ä–æ–≥—Ä–∞–º–º–∞ –∏–ª–∏ —É—Å–ª–æ–≤–∏—è –æ–±—É—á–µ–Ω–∏—è?"
        ]
    
    def detect_completed_action(self, message: str, route_result: Dict, history: List) -> Dict:
        """
        –ì–ª–∞–≤–Ω—ã–π –º–µ—Ç–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏.
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ offtopic —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
        
        Args:
            message: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            route_result: –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç Router
            history: –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞
            
        Returns:
            –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–ª–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç Router
        """
        # 1. –†–∞–±–æ—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ —Å offtopic
        if route_result.get('status') != 'offtopic':
            return route_result
        
        # 2. –ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
        message_lower = message.lower()
        
        # –ò—Å–∫–ª—é—á–∞–µ–º –≤–æ–ø—Ä–æ—Å—ã
        question_markers = ['?', '–∫–∞–∫', '—á—Ç–æ', '–∫–æ–≥–¥–∞', '–≥–¥–µ', '–ø–æ—á–µ–º—É', '–∑–∞—á–µ–º', 
                           '—Å–∫–æ–ª—å–∫–æ', '–∫–∞–∫–æ–π', '–∫–∞–∫–∞—è', '–∫–∞–∫–∏–µ', '–∫—É–¥–∞', '–æ—Ç–∫—É–¥–∞']
        if any(word in message_lower for word in question_markers):
            return route_result
        
        # –ò—Å–∫–ª—é—á–∞–µ–º –¥–ª–∏–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–≤–µ—Ä–æ—è—Ç–Ω–æ –Ω–µ –¥–µ–π—Å—Ç–≤–∏—è)
        if len(message.split()) > 10:
            return route_result
        
        # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–µ–π—Å—Ç–≤–∏–π
        detected_action = None
        is_school_related = False
        
        for action_type, patterns in self.ACTION_PATTERNS.items():
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–µ–π—Å—Ç–≤–∏—è
            if any(keyword in message_lower for keyword in patterns['keywords']):
                detected_action = action_type
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ª–æ–≤–∞-–∏—Å–∫–ª—é—á–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
                if 'exclusion_words' in patterns:
                    if any(excl in message_lower for excl in patterns['exclusion_words']):
                        # –ù–∞–π–¥–µ–Ω–æ –∏—Å–∫–ª—é—á–∞—é—â–µ–µ —Å–ª–æ–≤–æ - —ç—Ç–æ –ù–ï –ø—Ä–æ —à–∫–æ–ª—É
                        detected_action = None
                        continue
                
                # –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è —Å–ª–æ–≤ "–ø–µ—Ä–µ–≤–æ–¥" –∏ "–æ–ø–ª–∞—Ç–∏–ª" - —Ç—Ä–µ–±—É—é—Ç —è–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
                if detected_action == 'payment':
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ —Ç–æ–ª—å–∫–æ –æ–±—â–∏–µ —Å–ª–æ–≤–∞ –æ–ø–ª–∞—Ç—ã –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
                    payment_only_words = ['–æ–ø–ª–∞—Ç–∏–ª', '–æ–ø–ª–∞—Ç–∏–ª–∞', '–ø–µ—Ä–µ–≤–µ–ª', '–ø–µ—Ä–µ–≤–µ–ª–∞', '–ø–µ—Ä–µ–≤–æ–¥']
                    has_only_payment = any(word in message_lower for word in payment_only_words)
                    has_school_context = any(word in message_lower for word in ['–∫—É—Ä—Å', '–∑–∞–Ω—è—Ç', '–æ–±—É—á–µ–Ω', '—à–∫–æ–ª', 'ukido'])
                    
                    if has_only_payment and not has_school_context:
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —à–∫–æ–ª—ã
                        if not self._check_school_context_in_history(history):
                            # –ù–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —à–∫–æ–ª—ã –Ω–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏, –Ω–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
                            detected_action = None
                            continue
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç —à–∫–æ–ª—ã –≤ —Å–∞–º–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
                if any(context in message_lower for context in patterns['school_context']):
                    is_school_related = True
                    break
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ –∏—Å—Ç–æ—Ä–∏–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –ø–∞—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π)
                if self._check_school_context_in_history(history):
                    is_school_related = True
                    break
        
        # 4. –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –¥–µ–π—Å—Ç–≤–∏–µ –∏–ª–∏ –æ–Ω–æ –Ω–µ –ø—Ä–æ —à–∫–æ–ª—É - –æ—Å—Ç–∞–≤–ª—è–µ–º offtopic
        if not detected_action or not is_school_related:
            return route_result
        
        # 5. –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç Router'–∞
        corrected_result = route_result.copy()
        corrected_result['status'] = 'success'
        corrected_result['_action_detected'] = detected_action  # –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
        corrected_result['_correction_applied'] = 'completed_action'  # –ú–∞—Ä–∫–µ—Ä –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏
        
        # –í—ã–±–∏—Ä–∞–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–π –æ—Ç–≤–µ—Ç
        action_data = self.ACTION_PATTERNS[detected_action]
        
        # –í–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–π –∑–∞–º–µ–Ω—ã message, —Å–æ–∑–¥–∞—ë–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø–æ–ª–µ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞
        corrected_result['completed_action_response'] = random.choice(action_data['responses'])
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º implicit –≤–æ–ø—Ä–æ—Å—ã
        corrected_result['decomposed_questions'] = action_data['implicit_questions']
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
        if detected_action == 'payment':
            corrected_result['documents'] = ['pricing.md', 'conditions.md']
        elif detected_action in ['registration', 'trial']:
            corrected_result['documents'] = ['schedule.md', 'methodology.md']
        elif detected_action == 'form':
            corrected_result['documents'] = ['faq.md', 'conditions.md']
        else:
            corrected_result['documents'] = ['faq.md']
        
        # –õ–æ–≥–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        print(f"üîß Completed action detected: '{detected_action}' for message: '{message[:50]}...'")
        print(f"   School context: {is_school_related}, Documents: {corrected_result['documents']}")
        
        return corrected_result
    
    def _check_school_context_in_history(self, history: List) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –ø–∞—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç —à–∫–æ–ª—ã.
        
        Args:
            history: –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
            
        Returns:
            True –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç —à–∫–æ–ª—ã
        """
        if not history:
            return False
        
        # –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞, —É–∫–∞–∑—ã–≤–∞—é—â–∏–µ –Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç —à–∫–æ–ª—ã
        school_keywords = [
            '–∫—É—Ä—Å', '–∑–∞–Ω—è—Ç–∏–µ', '–æ–±—É—á–µ–Ω–∏–µ', '—Ä–µ–±–µ–Ω–æ–∫', '—Ä–µ–±—ë–Ω–æ–∫', '–¥–µ—Ç–∏', '–¥–µ—Ç–µ–π',
            '–ø—Ä–æ–≥—Ä–∞–º–º–∞', '—É—á–∏—Ç–µ–ª—å', '–ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å', '—É—Ä–æ–∫', '–≥—Ä—É–ø–ø–∞', '–∑–∞–ø–∏—Å—å',
            '—Ü–µ–Ω–∞', '—Å—Ç–æ–∏–º–æ—Å—Ç—å', '–æ–ø–ª–∞—Ç–∞', '—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ', 'zoom', '–æ–Ω–ª–∞–π–Ω', 
            '–º–µ—Ç–æ–¥–∏–∫–∞', '–Ω–∞–≤—ã–∫', 'skill', 'ukido', '—É–∫–∏–¥–æ', '—à–∫–æ–ª–∞'
        ]
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 6 —Å–æ–æ–±—â–µ–Ω–∏–π (3 –ø–∞—Ä—ã user-assistant)
        recent_messages = history[-6:] if len(history) >= 6 else history
        
        for msg in recent_messages:
            content = msg.get('content', '').lower()
            if any(keyword in content for keyword in school_keywords):
                return True
        
        return False
    
    def get_uncertain_response(self) -> str:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–µ–∂–ª–∏–≤—ã–π —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å –¥–ª—è –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤.
        
        Returns:
            –°–ª—É—á–∞–π–Ω–∞—è —Ñ—Ä–∞–∑–∞ –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è
        """
        return random.choice(self.UNCERTAIN_RESPONSES)