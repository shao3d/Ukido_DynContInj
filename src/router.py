"""
router.py - –ü—Å–µ–≤–¥–æ-–¥–≤—É—Ö—ç—Ç–∞–ø–Ω—ã–π LLM —Ä–æ—É—Ç–µ—Ä –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
–í–µ—Ä—Å–∏—è 2.0: –î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è + –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –≤ –æ–¥–Ω–æ–º –ø—Ä–æ–º–ø—Ç–µ
"""

import json
from pathlib import Path
from typing import List, Dict, Optional
from openrouter_client import OpenRouterClient
from gemini_cached_client import GeminiCachedClient
from config import Config
from social_intents import detect_social_intent, SocialIntent, has_business_signals_extended
from social_state import SocialStateManager
from social_responder import SocialResponder
from standard_responses import get_offtopic_response, DEFAULT_FALLBACK, NEED_SIMPLIFICATION_MESSAGE


class Router:
    """–†–æ—É—Ç–µ—Ä –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –≤—ã–±–æ—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤"""
    
    def __init__(self, use_cache: bool = True):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–æ—É—Ç–µ—Ä–∞ —Å –∑–∞–≥—Ä—É–∑–∫–æ–π —Å–∞–º–º–∞—Ä–∏
        
        Args:
            use_cache: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –¥–ª—è Gemini
        """
        config = Config()
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –¥–ª—è Gemini –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ
        if use_cache:
            self.client = GeminiCachedClient(
                config.OPENROUTER_API_KEY,
                seed=config.SEED,
                max_tokens=config.MAX_TOKENS,
                temperature=config.TEMPERATURE
            )
        else:
            self.client = OpenRouterClient(
                config.OPENROUTER_API_KEY,
                seed=config.SEED,
                max_tokens=config.MAX_TOKENS,
                temperature=config.TEMPERATURE,
                model="google/gemini-2.5-flash"
            )
        
        self.summaries = self._load_summaries()
        self.use_cache = use_cache
        # –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
        self._social_state = SocialStateManager()
        self._social_responder = SocialResponder(self._social_state)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–∞–º–º–∞—Ä–∏ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å
        if not self.summaries:
            print("‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: summaries.json –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!")
    
    def _is_recent_session(self, history: List[Dict[str, str]]) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –±—ã–ª–∞ –ª–∏ –Ω–µ–¥–∞–≤–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤ –¥–∏–∞–ª–æ–≥–µ (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —á–∞—Å–∞)
        
        Args:
            history: –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞
            
        Returns:
            True –µ—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±—ã–ª–æ –Ω–µ–¥–∞–≤–Ω–æ (—Å–µ—Å—Å–∏—è –∞–∫—Ç–∏–≤–Ω–∞)
        """
        # –ï—Å–ª–∏ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–µ—Ç –∏–ª–∏ –æ–Ω–∞ –ø—É—Å—Ç–∞—è - —Å—á–∏—Ç–∞–µ–º –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–µ–π
        if not history:
            return False
            
        # –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –µ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è, —Å—á–∏—Ç–∞–µ–º —Å–µ—Å—Å–∏—é –∞–∫—Ç–∏–≤–Ω–æ–π
        # –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫
        return len(history) > 0
    
    def _load_summaries(self) -> dict:
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç summaries.json –∏–∑ data/"""
        try:
            # –ü—É—Ç—å: src/ -> –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ -> data/summaries.json
            path = Path(__file__).parent.parent / "data" / "summaries.json"
            with open(path, "r", encoding="utf-8") as f:
                data = json.load(f)
                print(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(data)} —Å–∞–º–º–∞—Ä–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤")
                return data
        except FileNotFoundError:
            print(f"‚ùå –§–∞–π–ª summaries.json –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return {}
        except json.JSONDecodeError as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: {e}")
            return {}
        except Exception as e:
            print(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")
            return {}
    
    
    async def route(self, user_message: str, history: Optional[List[Dict[str, str]]] = None, user_id: str = "anonymous") -> dict:
        """
        –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ—à–µ–Ω–∏–µ –æ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
        
        Args:
            user_message: –¢–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            history: –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ —Ñ–æ—Ä–º–∞—Ç–∞ [{"role": "user/assistant", "content": "..."}]
            user_id: –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            
        Returns:
            –î–ª—è success: {"status": "success", "documents": ["doc1.md", "doc2.md"], "decomposed_questions": [...]}
            –î–ª—è –¥—Ä—É–≥–∏—Ö: {"status": "...", "message": "...", "decomposed_questions": [...]}
        """
        # –ó–∞—â–∏—Ç–∞ –æ—Ç None
        if history is None:
            history = []

        # –°–ü–ï–¶–ò–ê–õ–¨–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê –£–õ–¨–¢–†–ê-–ö–†–ê–¢–ö–ò–• –ö–û–ù–¢–ï–ö–°–¢–£–ê–õ–¨–ù–´–• –í–û–ü–†–û–°–û–í
        ultra_short_patterns = ["–∞?", "–∏?", "–∏ –≤—Å—ë?", "–∞ –¥–∞–ª—å—à–µ?", "–∏ —á—Ç–æ?", "–Ω—É –∏?"]
        if user_message.strip().lower() in ultra_short_patterns and history:
            # –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
            last_assistant_msg = None
            for msg in reversed(history):
                if msg.get("role") == "assistant":
                    last_assistant_msg = msg.get("content", "")
                    break
            
            if last_assistant_msg:
                print(f"üîç –û–±–Ω–∞—Ä—É–∂–µ–Ω —É–ª—å—Ç—Ä–∞-–∫—Ä–∞—Ç–∫–∏–π –≤–æ–ø—Ä–æ—Å '{user_message}' - –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏")
                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–º—É –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ—Ç–≤–µ—Ç–∞
                if "—Ü–µ–Ω" in last_assistant_msg.lower() or "—Å—Ç–æ–∏" in last_assistant_msg.lower():
                    expanded_question = "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ —Ü–µ–Ω–∞—Ö –∏ —Å–∫–∏–¥–∫–∞—Ö"
                elif "–∫—É—Ä—Å" in last_assistant_msg.lower():
                    expanded_question = "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ –∫—É—Ä—Å–∞—Ö"
                else:
                    expanded_question = "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ"
                
                # –ü–æ–¥–º–µ–Ω—è–µ–º –≤–æ–ø—Ä–æ—Å –Ω–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π
                user_message = expanded_question
                print(f"üìù –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å: {expanded_question}")

        # –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ª–∏—á–∏–µ –±–∏–∑–Ω–µ—Å-—Å–∏–≥–Ω–∞–ª–æ–≤ (–¥–ª—è mixed-–≥–µ–π—Ç–∞)
        has_business, was_fuzzy_matched = has_business_signals_extended(user_message)

        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ –∏–Ω—Ç–µ–Ω—Ç—ã (–±—ã—Å—Ç—Ä—ã–π –ø—É—Ç—å) ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ù–ï–¢ –±–∏–∑–Ω–µ—Å-—Å–∏–≥–Ω–∞–ª–æ–≤
        det = detect_social_intent(user_message)
        if det.intent != SocialIntent.UNKNOWN and det.confidence >= 0.7 and not has_business:
            # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ–Ω—Ç–∞
            print(f"‚ÑπÔ∏è Router: –û–±–Ω–∞—Ä—É–∂–µ–Ω —Å–æ—Ü–∏–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ–Ω—Ç '{det.intent.value}' –¥–ª—è user {user_id[:8]}...")
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
            if det.intent == SocialIntent.GREETING:
                if self._social_state.has_greeted(user_id):
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–æ—à–ª–æ –ª–∏ –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                    if self._is_recent_session(history):
                        print(f"üîç DEBUG: –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –æ—Ç {user_id[:8]}...")
                        # –ü–µ—Ä–µ–¥–∞–µ–º Claude –¥–ª—è —É–º–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
                        return {
                            "status": "success",
                            "social_context": "repeated_greeting",
                            "documents": [],
                            "decomposed_questions": ["–ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ"]
                        }
                    else:
                        # –ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è –ø–æ—Å–ª–µ –¥–æ–ª–≥–æ–π –ø–∞—É–∑—ã
                        print(f"‚ÑπÔ∏è Router: –ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è –¥–ª—è {user_id[:8]}... (–¥–æ–ª–≥–∞—è –ø–∞—É–∑–∞)")
                        self._social_state.mark_greeted(user_id)
                else:
                    # –ü–µ—Ä–≤–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –≤ —Å–µ—Å—Å–∏–∏
                    self._social_state.mark_greeted(user_id)
                    print(f"‚ÑπÔ∏è Router: –ü–µ—Ä–≤–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –æ—Ç {user_id[:8]}...")
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–æ—Ü–∏–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
            reply = self._social_responder.respond(user_id, det.intent)
            
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ offtopic —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º –∏ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
            return {
                "status": "offtopic", 
                "message": reply, 
                "social_context": det.intent.value,
                "decomposed_questions": [], 
                "fuzzy_matched": was_fuzzy_matched
            }


        # –°—Ç—Ä–æ–∏–º –ø—Ä–æ–º–ø—Ç —Å–æ–≥–ª–∞—Å–Ω–æ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ (—Ä–∞–∑–¥–µ–ª—è–µ–º —Ä–æ–ª–∏)
        prompts = self._build_router_prompts(user_message, history)
        
        try:
            # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç Gemini —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ
            if self.use_cache and isinstance(self.client, GeminiCachedClient):
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è Gemini
                response = await self.client.chat_with_cache(
                    system_content=prompts["system"],
                    user_message=prompts["user"],
                    history=None  # –ò—Å—Ç–æ—Ä–∏—è —É–∂–µ –≤–∫–ª—é—á–µ–Ω–∞ –≤ user_message
                )
            else:
                # –û–±—ã—á–Ω—ã–π –º–µ—Ç–æ–¥
                messages = [
                    {"role": "system", "content": prompts["system"]},
                    {"role": "user", "content": prompts["user"]},
                ]
                response = await self.client.chat(messages)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ—Ç–≤–µ—Ç –Ω–µ –ø—É—Å—Ç–æ–π
            if not response or response.strip() == "":
                print("‚ö†Ô∏è –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç Gemini")
                return self._fallback_response()
            
            # –ü–∞—Ä—Å–∏–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
            try:
                # –û—á–∏—â–∞–µ–º –æ—Ç markdown code blocks (```json...```)
                cleaned_response = response.strip()
                if cleaned_response.startswith("```json"):
                    cleaned_response = cleaned_response[7:]
                if cleaned_response.endswith("```"):
                    cleaned_response = cleaned_response[:-3]
                cleaned_response = cleaned_response.strip()
                
                result = json.loads(cleaned_response)
                
                # –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ—Ç–≤–µ—Ç–∞
                if not isinstance(result, dict):
                    raise ValueError("Response is not a dict")
                    
                if "status" not in result:
                    raise ValueError("Missing 'status' field")
                
                # –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ decomposed_questions (–≤—Å–µ–≥–¥–∞ —Å–ø–∏—Å–æ–∫)
                if "decomposed_questions" not in result or not isinstance(result.get("decomposed_questions"), list):
                    result["decomposed_questions"] = []
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Å—Ç–∞—Ç—É—Å–∞
                valid_statuses = ["success", "offtopic", "need_simplification"]
                valid_signals = ["price_sensitive", "anxiety_about_child", "ready_to_buy", "exploring_only"]
                
                # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª—É—á–∞—è, –∫–æ–≥–¥–∞ Gemini –ø—É—Ç–∞–µ—Ç status –∏ user_signal
                if result["status"] in valid_signals and result["status"] not in valid_statuses:
                    # Gemini –≤–µ—Ä–Ω—É–ª user_signal –≤–º–µ—Å—Ç–æ status - –∏—Å–ø—Ä–∞–≤–ª—è–µ–º
                    actual_signal = result["status"]
                    result["status"] = "success"  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é success –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
                    if "user_signal" not in result:
                        result["user_signal"] = actual_signal
                    print(f"‚ö†Ô∏è –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—É—Ç–∞–Ω–∏—Ü–∞ status/signal: {actual_signal} ‚Üí success")
                
                if result["status"] not in valid_statuses:
                    raise ValueError(f"Invalid status: {result['status']}")
                
                # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤–æ–ø—Ä–æ—Å–æ–≤ —Å—Ç–∞—Ç—É—Å—É
                if "decomposed_questions" in result:
                    questions_count = len(result["decomposed_questions"])
                    # MVP: –¥–æ–ø—É—Å–∫–∞–µ–º –¥–æ 3 –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ —Å—Ç–∞—Ç—É—Å–µ success, 4+ ‚Üí need_simplification
                    if result["status"] == "success" and questions_count > 3:
                        print(f"‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: —Å—Ç–∞—Ç—É—Å 'success' —Å {questions_count} –≤–æ–ø—Ä–æ—Å–∞–º–∏! –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ 'need_simplification'")
                        result["status"] = "need_simplification"
                        result["message"] = NEED_SIMPLIFICATION_MESSAGE
                        if "documents" in result:
                            del result["documents"]

                    # –ö–æ—Ä—Ä–µ–∫—Ü–∏—è: –µ—Å–ª–∏ –º–æ–¥–µ–ª—å –≤–µ—Ä–Ω—É–ª–∞ need_simplification –ø—Ä–∏ 1‚Äì3 –≤–æ–ø—Ä–æ—Å–∞—Ö, –≤—ã–ø–æ–ª–Ω—è–µ–º –æ–¥–∏–Ω –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å –∂—ë—Å—Ç–∫–æ–π –ø–æ–¥—Å–∫–∞–∑–∫–æ–π
                    if result.get("status") == "need_simplification" and 1 <= questions_count <= 3:
                        print("üîÅ –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å: need_simplification –ø—Ä–∏ ‚â§3 –≤–æ–ø—Ä–æ—Å–∞—Ö. –¢—Ä–µ–±—É–µ–º success.")
                        strict_hint = (
                            "\n=== –ö–û–†–†–ï–ö–¶–ò–Ø (–°–¢–†–û–ì–û) ===\n"
                            "–ï—Å–ª–∏ –≤ decomposed_questions –†–û–í–ù–û 1, 2 –∏–ª–∏ 3 –≤–æ–ø—Ä–æ—Å–∞ ‚Äî –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤–µ—Ä–Ω–∏ status: \"success\".\n"
                            "–ü–æ–¥–±–µ—Ä–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º: –º–∞–∫—Å–∏–º—É–º 4 –Ω–∞ –≤–µ—Å—å –æ—Ç–≤–µ—Ç; –ø–æ –æ–¥–Ω–æ–º—É –æ—Å–Ω–æ–≤–Ω–æ–º—É (primary) –Ω–∞ –∫–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å –∏, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏, –æ–¥–∏–Ω –æ–±—â–∏–π support-–¥–æ–∫—É–º–µ–Ω—Ç, –µ—Å–ª–∏ –æ–Ω –ø–æ–∫—Ä—ã–≤–∞–µ—Ç 2+ –≤–æ–ø—Ä–æ—Å–æ–≤.\n"
                            "–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON –ø–æ —Ñ–æ—Ä–º–∞—Ç—É –Ω–∏–∂–µ, –±–µ–∑ markdown –∏ —Ç–µ–∫—Å—Ç–∞.\n"
                        )
                        prompts2 = self._build_router_prompts(user_message, history, extra_hint=strict_hint)
                        
                        # –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
                        if self.use_cache and isinstance(self.client, GeminiCachedClient):
                            response2 = await self.client.chat_with_cache(
                                system_content=prompts2["system"],
                                user_message=prompts2["user"],
                                history=None
                            )
                        else:
                            messages2 = [
                                {"role": "system", "content": prompts2["system"]},
                                {"role": "user", "content": prompts2["user"]},
                            ]
                            response2 = await self.client.chat(messages2)
                        if response2 and response2.strip():
                            cleaned2 = response2.strip()
                            if cleaned2.startswith("```json"):
                                cleaned2 = cleaned2[7:]
                            if cleaned2.endswith("```"):
                                cleaned2 = cleaned2[:-3]
                            cleaned2 = cleaned2.strip()
                            try:
                                result2 = json.loads(cleaned2)
                                if isinstance(result2, dict) and result2.get("status") in ["success", "offtopic", "need_simplification"]:
                                    # –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ decomposed_questions –≤ –æ—Ç–≤–µ—Ç–µ –ø–æ–≤—Ç–æ—Ä–∞
                                    if "decomposed_questions" not in result2 or not isinstance(result2.get("decomposed_questions"), list):
                                        result2["decomposed_questions"] = []
                                    result = result2
                                    print("‚úÖ –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å –ø—Ä–∏–Ω—è—Ç.")
                            except Exception:
                                print("‚ö†Ô∏è –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å, –æ—Å—Ç–∞–≤–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π.")
                
                # –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: –µ—Å–ª–∏ –≤—Å—ë –µ—â—ë need_simplification –ø—Ä–∏ ‚â§3 –≤–æ–ø—Ä–æ—Å–∞—Ö
                # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –º–µ–Ω—è–µ–º –Ω–∞ success (Gemini –∏–Ω–æ–≥–¥–∞ —É–ø—Ä—è–º–∏—Ç—Å—è)
                if result.get("status") == "need_simplification":
                    questions_count = len(result.get("decomposed_questions", []))
                    if 1 <= questions_count <= 3:
                        print(f"‚ö†Ô∏è OVERRIDE: need_simplification –ø—Ä–∏ {questions_count} –≤–æ–ø—Ä–æ—Å–∞—Ö ‚Üí success")
                        result["status"] = "success"
                        # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–¥–æ–±—Ä–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
                        if questions_count > 0:
                            # –ü—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞ –¥–ª—è –ø–æ–¥–±–æ—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
                            question_text = " ".join(result["decomposed_questions"]).lower()
                            result["documents"] = []
                            if "—Å–∫–∏–¥–∫" in question_text or "—Ü–µ–Ω" in question_text or "—Å—Ç–æ–∏" in question_text:
                                result["documents"].append("pricing.md")
                            if "–±–ª–æ–≥–µ—Ä" in question_text or "—Ä–µ–∫–ª–∞–º" in question_text or "—Å–æ—Ç—Ä—É–¥–Ω–∏—á" in question_text:
                                result["documents"].append("partners.md")
                            if not result["documents"]:
                                result["documents"] = ["faq.md"]  # Fallback –¥–æ–∫—É–º–µ–Ω—Ç
                
                # –î–ª—è success –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å documents, –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö - message
                if result["status"] == "success":
                    if "documents" not in result or not isinstance(result["documents"], list):
                        raise ValueError("Success status requires 'documents' list")
                    # –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ 4 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (MVP)
                    docs_in = result.get("documents", [])
                    seen = set()
                    docs_dedup = []
                    for d in docs_in:
                        if isinstance(d, str) and d not in seen:
                            seen.add(d)
                            docs_dedup.append(d)
                    if len(docs_dedup) > 4:
                        print(f"‚ÑπÔ∏è –û–±—Ä–µ–∑–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–æ 4 (–±—ã–ª–æ {len(docs_dedup)})")
                        docs_dedup = docs_dedup[:4]
                    result["documents"] = docs_dedup
                    # –í—ã–≤–æ–¥–∏–º —Å—Ç–∞—Ç—É—Å –∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã –¥–ª—è success
                    print(f"‚úÖ –°—Ç–∞—Ç—É—Å: {result['status']}")
                    print(f"üìã –í—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã: {', '.join(result['documents'])}")
                    if "decomposed_questions" in result:
                        print(f"üîç –î–µ–∫–æ–º–ø–æ–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã: {result['decomposed_questions']}")
                else:
                    # –î–ª—è offtopic –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—É—é —Ñ—Ä–∞–∑—É –≤–º–µ—Å—Ç–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
                    if result["status"] == "offtopic":
                        result["message"] = get_offtopic_response()
                        print(f"‚ÑπÔ∏è –°—Ç–∞—Ç—É—Å: offtopic (–∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—É—é —Ñ—Ä–∞–∑—É)")
                    elif "message" not in result or not isinstance(result["message"], str):
                        raise ValueError(f"{result['status']} status requires 'message' string")
                    else:
                        # –í—ã–≤–æ–¥–∏–º —Å—Ç–∞—Ç—É—Å –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤
                        print(f"‚ÑπÔ∏è –°—Ç–∞—Ç—É—Å: {result['status']}")
                    if "decomposed_questions" in result:
                        print(f"üîç –î–µ–∫–æ–º–ø–æ–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã: {result['decomposed_questions']}")
                
                # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–ª–∞–≥ fuzzy_matched –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                result["fuzzy_matched"] = was_fuzzy_matched
                
                # MVP: –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –¥–ª—è mixed –∑–∞–ø—Ä–æ—Å–æ–≤
                if result.get("status") == "success" and result.get("social_context") == "greeting":
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–æ –ª–∏ —É–∂–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –≤ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏
                    if self._social_state.has_greeted(user_id):
                        print(f"üîç DEBUG: Mixed –∑–∞–ø—Ä–æ—Å —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º –æ—Ç {user_id[:8]}...")
                        result["social_context"] = "repeated_greeting"
                    else:
                        # –ü–µ—Ä–≤–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –≤ mixed –∑–∞–ø—Ä–æ—Å–µ - –æ—Ç–º–µ—á–∞–µ–º
                        self._social_state.mark_greeted(user_id)
                        print(f"‚ÑπÔ∏è Router: –ü–µ—Ä–≤–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –≤ mixed –∑–∞–ø—Ä–æ—Å–µ –æ—Ç {user_id[:8]}...")
                
                
                return result
                
            except (json.JSONDecodeError, ValueError) as e:
                print(f"‚ö†Ô∏è –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç Gemini: {e}")
                return self._fallback_response()
                
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ Gemini: {e}")
            return self._fallback_response()
    
    def _build_router_prompts(self, user_message: str, history: List[Dict[str, str]], extra_hint: Optional[str] = None) -> Dict[str, str]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–≤–∞ –±–ª–æ–∫–∞ –ø—Ä–æ–º–ø—Ç–∞: system –∏ user.
        system ‚Äî —Ä–æ–ª—å –∏ —Å—Ç—Ä–æ–≥–∏–µ –ø—Ä–∞–≤–∏–ª–∞/—Ñ–æ—Ä–º–∞—Ç.
        user ‚Äî –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π, –∏—Å—Ç–æ—Ä–∏—è, —Ç–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å, –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —à–∞–≥–∞–º (+extra_hint).
        """
        # System: —Ä–æ–ª—å + —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –∫–∞–∫ —Å—Ç—Ä–æ–≥–∏–µ –ø—Ä–∞–≤–∏–ª–∞
        system_content = self._get_role_section()
        system_content += self._get_response_format_section()

        # User: –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π + –∏—Å—Ç–æ—Ä–∏—è + —Ç–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å + —ç—Ç–∞–ø—ã
        user_content = ""
        user_content += self._get_summaries_section()
        user_content += self._get_history_section(history)
        user_content += f"\n=== –¢–ï–ö–£–©–ò–ô –ó–ê–ü–†–û–° ===\nUser: {user_message}\n\n"
        user_content += self._get_decomposition_section()
        user_content += self._get_classification_section()
        if extra_hint:
            user_content += extra_hint + "\n\n"
        return {"system": system_content, "user": user_content}
    
    def _get_role_section(self) -> str:
        """–°–µ–∫—Ü–∏—è —Å —Ä–æ–ª—å—é –∏ –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏"""
        return """–¢—ã - –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å –¥–µ—Ç—Å–∫–æ–π —à–∫–æ–ª—ã soft skills Ukido.

–î–í–ê –≠–¢–ê–ü–ê –ê–ù–ê–õ–ò–ó–ê:
1. –î–ï–ö–û–ú–ü–û–ó–ò–¶–ò–Ø - –∏–∑–≤–ª–µ—á—å –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã
2. –ö–õ–ê–°–°–ò–§–ò–ö–ê–¶–ò–Ø - —Å—Ç–∞—Ç—É—Å –∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã

–ü–†–ê–í–ò–õ–ê:
- –ú–∞–∫—Å–∏–º—É–º 3 –≤–æ–ø—Ä–æ—Å–∞ –¥–ª—è success
- 4+ –≤–æ–ø—Ä–æ—Å–∞ = need_simplification
- –ú–∞–∫—Å–∏–º—É–º 4 –¥–æ–∫—É–º–µ–Ω—Ç–∞
- –í–ê–ñ–ù–û: –ë—É–¥—å —Ç–æ–ª–µ—Ä–∞–Ω—Ç–µ–Ω –∫ –≤–æ–ø—Ä–æ—Å–∞–º –æ —à–∫–æ–ª–µ
- –°–∫–µ–ø—Ç–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, "—ç—Ç–æ –Ω–µ —Å–µ–∫—Ç–∞?") –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–π –∫–∞–∫ success –∏ –≤—ã–±–∏—Ä–∞–π ukido_philosophy.md –∏–ª–∏ safety_and_trust.md

"""
    
    def _get_summaries_section(self) -> str:
        """–°–µ–∫—Ü–∏—è —Å —Å–∞–º–º–∞—Ä–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤"""
        return f"""=== –ë–ê–ó–ê –ó–ù–ê–ù–ò–ô (–î–û–°–¢–£–ü–ù–´–ï –î–û–ö–£–ú–ï–ù–¢–´) ===
{json.dumps(self.summaries, ensure_ascii=False, indent=2)}

"""
    
    def _get_history_section(self, history: List[Dict[str, str]]) -> str:
        """–°–µ–∫—Ü–∏—è —Å –∏—Å—Ç–æ—Ä–∏–µ–π –¥–∏–∞–ª–æ–≥–∞"""
        if not history:
            return ""
            
        section = "=== –ò–°–¢–û–†–ò–Ø –î–ò–ê–õ–û–ì–ê ===\n"
        section += "(–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)\n\n"

        # –ë–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π
        recent_history = history[-10:] if len(history) > 10 else history

        for msg in recent_history:
            role = "User" if msg.get("role") == "user" else "Assistant"
            content = msg.get("content", "")
            section += f"{role}: {content}\n"

        section += """
–ò–°–ü–û–õ–¨–ó–£–ô –ò–°–¢–û–†–ò–Æ –î–õ–Ø:
- –ü–æ–Ω–∏–º–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –Ω–µ–ø–æ–ª–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ ("–ê —ç—Ç–æ –ø–ª–∞—Ç–Ω–æ?" ‚Üí –æ —á—ë–º "—ç—Ç–æ"?)
- –î–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∫ –æ—Ç–æ—Ä–≤–∞–Ω–Ω—ã–º –≤–æ–ø—Ä–æ—Å–∞–º
- –ü–æ–Ω–∏–º–∞–Ω–∏—è —á—Ç–æ —É–∂–µ –æ–±—Å—É–∂–¥–∞–ª–æ—Å—å
- –ö–†–ò–¢–ò–ß–ù–û: –î–ª—è —É–ª—å—Ç—Ä–∞-–∫—Ä–∞—Ç–∫–∏—Ö —Ä–µ–ø–ª–∏–∫ ("–ê?", "–ò –≤—Å—ë?", "–ê –¥–∞–ª—å—à–µ?") - 
  —ç—Ç–æ –í–°–ï–ì–î–ê –∫–æ–Ω—Ç–µ–∫—Å—Ç—É–∞–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Ç–µ–º–µ!
  –ù–ï offtopic! –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏ —Å–º—ã—Å–ª –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏!
  
–û–°–û–ë–û–ï –ü–†–ê–í–ò–õ–û –î–õ–Ø "–ê?":
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–ø–∏—Å–∞–ª —Ç–æ–ª—å–∫–æ "–ê?" - —ç—Ç–æ –í–°–ï–ì–î–ê –ø—Ä–æ—Å—å–±–∞ —É—Ç–æ—á–Ω–∏—Ç—å/–ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç.
–ü–æ—Å–º–æ—Ç—Ä–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç Assistant –∏ –æ–ø—Ä–µ–¥–µ–ª–∏, –æ —á—ë–º —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç.
–ü—Ä–∏–º–µ—Ä: –µ—Å–ª–∏ –≥–æ–≤–æ—Ä–∏–ª–∏ –æ —Ü–µ–Ω–∞—Ö ‚Üí "–ê?" = "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ —Ü–µ–Ω–∞—Ö"
"""
        
        return section
    
    def _get_decomposition_section(self) -> str:
        """–°–µ–∫—Ü–∏—è –¥–ª—è —ç—Ç–∞–ø–∞ –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏"""
        return """
=== –≠–¢–ê–ü 1: –î–ï–ö–û–ú–ü–û–ó–ò–¶–ò–Ø ===

–ò–∑–≤–ª–µ–∫–∏ –í–°–ï –≤–æ–ø—Ä–æ—Å—ã –∏–∑ –∑–∞–ø—Ä–æ—Å–∞:
1. –Ø–≤–Ω—ã–µ (—Å "?")
2. –°–∫—Ä—ã—Ç—ã–µ ("–∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç", "—Ö–æ—á—É —É–∑–Ω–∞—Ç—å", "—Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ")
3. –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ ("–ê?", "–ò?", "–î–∞–ª—å—à–µ?" - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏)

–í–ê–ñ–ù–û –¥–ª—è –∫—Ä–∞—Ç–∫–∏—Ö —Ä–µ–ø–ª–∏–∫:
- "–ê?" / "–ò?" = –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ç–µ–º—ã –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
- "–≠—Ç–æ –∫–∞–∫?" = –ø—Ä–æ—Å—å–±–∞ –æ–±—ä—è—Å–Ω–∏—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ
- –í–°–ï–ì–î–ê –ø—Ä–æ–≤–µ—Ä—è–π –∫–æ–Ω—Ç–µ–∫—Å—Ç!

–ò–ì–ù–û–†–ò–†–£–ô —Ç–æ–ª—å–∫–æ:
- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è/–ø—Ä–æ—â–∞–Ω–∏—è/–±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏
- –ú–∞—Ç –∏ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è
- –Ø–≤–Ω—ã–π –æ—Ñ—Ñ—Ç–æ–ø–∏–∫ (–ø–æ–≥–æ–¥–∞, –ø–æ–ª–∏—Ç–∏–∫–∞)

–ü–†–ò–ú–ï–†–´ –î–ï–ö–û–ú–ü–û–ó–ò–¶–ò–ò:

–ó–∞–ø—Ä–æ—Å: "–ü—Ä–∏–≤–µ—Ç! –°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –∫—É—Ä—Å –¥–ª—è 10-–ª–µ—Ç–Ω–µ–≥–æ –∏ –µ—Å—Ç—å –ª–∏ —Å–∫–∏–¥–∫–∏?"
‚Üí 1. "–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –∫—É—Ä—Å?" 2. "–î–ª—è 10 –ª–µ—Ç –ø–æ–¥—Ö–æ–¥–∏—Ç?" 3. "–ö–∞–∫–∏–µ —Å–∫–∏–¥–∫–∏?"

–í–ê–ñ–ù–û: –û–±—ä–µ–¥–∏–Ω—è–π —Å–≤—è–∑–∞–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã!
–ó–∞–ø—Ä–æ—Å: "–£ –º–µ–Ω—è –¥–≤–æ–µ –¥–µ—Ç–µ–π 8 –∏ 12 –ª–µ—Ç, –º–ª–∞–¥—à–∏–π —Å—Ç–µ—Å–Ω–∏—Ç–µ–ª—å–Ω—ã–π, —Å—Ç–∞—Ä—à–∏–π –≥–∏–ø–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π"
‚Üí "–ö–∞–∫–∏–µ –∫—É—Ä—Å—ã –ø–æ–¥–æ–π–¥—É—Ç –¥–ª—è —Å—Ç–µ—Å–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ 8 –ª–µ—Ç –∏ –≥–∏–ø–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ 12 –ª–µ—Ç?"

–° –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º:
–ò—Å—Ç–æ—Ä–∏—è: –æ–±—Å—É–∂–¥–∞–ª–∏ –ø—Ä–æ–±–Ω—ã–π —É—Ä–æ–∫
–ó–∞–ø—Ä–æ—Å: "–ê —ç—Ç–æ –ø–ª–∞—Ç–Ω–æ?"
‚Üí "–ü—Ä–æ–±–Ω—ã–π —É—Ä–æ–∫ –ø–ª–∞—Ç–Ω—ã–π?"

–£–ª—å—Ç—Ä–∞-–∫—Ä–∞—Ç–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã (–í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏—Å—Ç–æ—Ä–∏–∏):
- "–ê?" ‚Üí –ø—Ä–æ–¥–æ–ª–∂–∏/—É—Ç–æ—á–Ω–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ç–≤–µ—Ç
- "–ò?" ‚Üí —á—Ç–æ –µ—â–µ –ø–æ —ç—Ç–æ–π —Ç–µ–º–µ
- "–ò –≤—Å—ë?" ‚Üí –¥–∞–π –±–æ–ª—å—à–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
- "–ê –¥–∞–ª—å—à–µ?" ‚Üí —á—Ç–æ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ
- "–ò —á—Ç–æ —ç—Ç–æ –¥–∞—ë—Ç?" ‚Üí –∫–∞–∫–∞—è –ø–æ–ª—å–∑–∞/—Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç –æ–±—Å—É–∂–¥–∞–µ–º–æ–≥–æ

–û—Ñ—Ñ—Ç–æ–ø–∏–∫ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º:
"–£ –≤–∞—Å –µ—Å—Ç—å –∫—É—Ä—Å—ã? –ö–∞–∫–∞—è –ø–æ–≥–æ–¥–∞?" ‚Üí —Ç–æ–ª—å–∫–æ ["–ö–∞–∫–∏–µ –∫—É—Ä—Å—ã –µ—Å—Ç—å?"]

4+ –≤–æ–ø—Ä–æ—Å–∞ = need_simplification:
"–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç, –∫—Ç–æ –≤–µ–¥–µ—Ç, —Å–∫–æ–ª—å–∫–æ –¥–µ—Ç–µ–π, —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ?" ‚Üí 4 –≤–æ–ø—Ä–æ—Å–∞ ‚Üí need_simplification

–°–û–¶–ò–ê–õ–¨–ù–´–ô –ö–û–ù–¢–ï–ö–°–¢ (–æ—Ç–º–µ—á–∞–π, –Ω–æ –Ω–µ –≤–∫–ª—é—á–∞–π –≤ –≤–æ–ø—Ä–æ—Å—ã):
- greeting (–ø—Ä–∏–≤–µ—Ç), thanks (—Å–ø–∞—Å–∏–±–æ), apology (–∏–∑–≤–∏–Ω–∏—Ç–µ), farewell (–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è)
"–ü—Ä–∏–≤–µ—Ç! –°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç?" ‚Üí social_context: "greeting", –≤–æ–ø—Ä–æ—Å—ã: ["–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç?"]

–†–ï–ó–£–õ–¨–¢–ê–¢ –î–ï–ö–û–ú–ü–û–ó–ò–¶–ò–ò:
–°–ø–∏—Å–æ–∫ —á—ë—Ç–∫–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –ë–ï–ó —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ + –æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ social_context.
–ü–û–ú–ù–ò: –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–æ—Å—å –±–æ–ª—å—à–µ 3 –≤–æ–ø—Ä–æ—Å–æ–≤ - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –Ω–∞ —ç—Ç–∞–ø–µ –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏–∏! 
–°—Ç–∞—Ç—É—Å need_simplification –±—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º —ç—Ç–∞–ø–µ.

"""
    
    def _get_classification_section(self) -> str:
        """–°–µ–∫—Ü–∏—è –¥–ª—è —ç—Ç–∞–ø–∞ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏"""
        return """
=== –≠–¢–ê–ü 2: –ö–õ–ê–°–°–ò–§–ò–ö–ê–¶–ò–Ø –ò –í–´–ë–û–† –î–û–ö–£–ú–ï–ù–¢–û–í ===

–ó–ê–î–ê–ß–ê: –ù–∞ –æ—Å–Ω–æ–≤–µ –¥–µ–∫–æ–º–ø–æ–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∏ –≤—ã–±—Ä–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã.

–®–ê–ì 1: –ü–û–î–°–ß–Å–¢ –®–ö–û–õ–¨–ù–´–• –í–û–ü–†–û–°–û–í
- –ü–æ—Å—á–∏—Ç–∞–π –¢–û–ß–ù–û–ï –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –∏–∑ –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ (decomposed_questions)
- –í—Å–µ –≤–æ–ø—Ä–æ—Å—ã –∏–∑ –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ - —à–∫–æ–ª—å–Ω—ã–µ (–æ—Ñ—Ñ—Ç–æ–ø–∏–∫ —É–∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω)
- –í–ê–ñ–ù–û: —Å—á–∏—Ç–∞–π –∏–º–µ–Ω–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ —Å–ø–∏—Å–∫–µ –¥–µ–∫–æ–º–ø–æ–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤!

–®–ê–ì 2: –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê
- 0 –≤–æ–ø—Ä–æ—Å–æ–≤ ‚Üí offtopic
- 1-3 –≤–æ–ø—Ä–æ—Å–∞ ‚Üí success ‚úÖ
- 4+ –≤–æ–ø—Ä–æ—Å–æ–≤ ‚Üí need_simplification

–í–ê–ñ–ù–û: –ü—Ä–∏ —Å–æ–º–Ω–µ–Ω–∏—è—Ö –º–µ–∂–¥—É offtopic –∏ success - –≤—ã–±–∏—Ä–∞–π success!

–ü–†–ò–ú–ï–†–´ –ü–û–î–°–ß–Å–¢–ê:
- ["–ö–∞–∫–∞—è —Ü–µ–Ω–∞?", "–ï—Å—Ç—å –ª–∏ —Å–∫–∏–¥–∫–∏?"] ‚Üí 2 –≤–æ–ø—Ä–æ—Å–∞ ‚Üí success ‚úÖ
- ["–ö–∞–∫–∞—è —Ü–µ–Ω–∞?", "–ö—Ç–æ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏?", "–ö–æ–≥–¥–∞ –∑–∞–Ω—è—Ç–∏—è?"] ‚Üí 3 –≤–æ–ø—Ä–æ—Å–∞ ‚Üí success ‚úÖ
- ["–ö–∞–∫–∞—è —Ü–µ–Ω–∞?", "–ï—Å—Ç—å –ª–∏ —Å–∫–∏–¥–∫–∏?", "–ö—Ç–æ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏?", "–ö–æ–≥–¥–∞ –∑–∞–Ω—è—Ç–∏—è?"] ‚Üí 4 –≤–æ–ø—Ä–æ—Å–∞ ‚Üí need_simplification ‚ö†Ô∏è
- [] ‚Üí 0 –≤–æ–ø—Ä–æ—Å–æ–≤ ‚Üí offtopic ‚ùå

–®–ê–ì 3: –í–´–ë–û–† –î–û–ö–£–ú–ï–ù–¢–û–í (—Ç–æ–ª—å–∫–æ –¥–ª—è status: "success")
–¶–ï–õ–¨: –ø–æ–∫—Ä—ã—Ç—å –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–∏ –ª–∏–º–∏—Ç–µ –º–∞–∫—Å–∏–º—É–º 4 –¥–æ–∫—É–º–µ–Ω—Ç–∞.

–ê–õ–ì–û–†–ò–¢–ú –í–´–ë–û–†–ê:
1) –î–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –≤—ã–±–µ—Ä–∏ 1-2 –¥–æ–∫—É–º–µ–Ω—Ç–∞:
   - 1 –æ—Å–Ω–æ–≤–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç (primary) - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π
   - 1 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π (support) - –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
2) –ü–æ—Å–ª–µ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
   - 1 –≤–æ–ø—Ä–æ—Å ‚Üí 1-2 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞
   - 2 –≤–æ–ø—Ä–æ—Å–∞ ‚Üí 2-4 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞  
   - 3 –≤–æ–ø—Ä–æ—Å–∞ ‚Üí 3-4 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞
3) –ò—Å–ø–æ–ª—å–∑—É–π –∏–∑ —Å–∞–º–º–∞—Ä–∏:
   - trigger_words (–∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞)
   - typical_questions (—Ç–∏–ø–∏—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã)
   - core_topics (–æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã)
   - related_docs (—Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã)

–ü–†–ê–í–ò–õ–ê –í–´–ë–û–†–ê –î–û–ö–£–ú–ï–ù–¢–û–í:
- "–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç?" ‚Üí pricing.md
- "–ö—Ç–æ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏?" ‚Üí teachers_team.md  
- "–ö–∞–∫–∏–µ –∫—É—Ä—Å—ã?" ‚Üí courses_detailed.md
- "–ö–∞–∫ –ø—Ä–æ—Ö–æ–¥—è—Ç –∑–∞–Ω—è—Ç–∏—è?" ‚Üí methodology.md
- "–ï—Å—Ç—å –ª–∏ –ø—Ä–æ–±–Ω—ã–π —É—Ä–æ–∫?" ‚Üí faq.md
- "–ö–∞–∫–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ?" ‚Üí conditions.md
- "–ö–∞–∫ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è?" ‚Üí faq.md
- "–ß—Ç–æ —Ä–∞–∑–≤–∏–≤–∞–µ—Ç–µ?" ‚Üí ukido_philosophy.md + methodology.md

–û–ü–ï–†–ê–¶–ò–û–ù–ù–´–ï –†–ï–ü–õ–ò–ö–ò (–≤—Å–µ–≥–¥–∞ —à–∫–æ–ª—å–Ω—ã–µ, status: "success"):
- ¬´–ó–∞–ø–∏—à–∏—Ç–µ –Ω–∞—Å¬ª, ¬´–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–æ–±–Ω—ã–π¬ª, ¬´–î–∞–≤–∞–π—Ç–µ –ø–æ–ø—Ä–æ–±—É–µ–º¬ª,
- ¬´–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É¬ª, ¬´–î–∞–π—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç/–ø–æ—á—Ç—É¬ª, ¬´–•–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è¬ª, ¬´–ö–∞–∫ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è¬ª,
- –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ –∑–∞–ø–∏—Å–∏ –∏ —É—Å–ª–æ–≤–∏—è—Ö ‚Üí faq.md, conditions.md
- –í–æ–ø—Ä–æ—Å—ã –æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö —à–∫–æ–ª—ã: ¬´–ø–æ–∫–∞–∂–∏—Ç–µ –ª–∏—Ü–µ–Ω–∑–∏—é¬ª, ¬´–µ—Å—Ç—å –ª–∏ –ª–∏—Ü–µ–Ω–∑–∏—è¬ª, ¬´—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã¬ª, ¬´—Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è¬ª,
  ¬´–¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—É—é –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å¬ª ‚Üí —ç—Ç–æ –®–ö–û–õ–¨–ù–´–ï –≤–æ–ø—Ä–æ—Å—ã ‚Üí safety_and_trust.md, faq.md

–û–ë–™–ï–î–ò–ù–ï–ù–ò–ï –î–û–ö–£–ú–ï–ù–¢–û–í:
- –£–±–µ—Ä–∏ –¥—É–±–ª–∏–∫–∞—Ç—ã (–µ—Å–ª–∏ –¥–ª—è –¥–≤—É—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –Ω—É–∂–µ–Ω –æ–¥–∏–Ω –¥–æ–∫—É–º–µ–Ω—Ç)
- –ú–∞–∫—Å–∏–º—É–º 4 –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–∞ –≤–µ—Å—å –æ—Ç–≤–µ—Ç
- –ü–µ—Ä–≤—ã–µ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É - –¥–æ–∫—É–º–µ–Ω—Ç—ã –¥–ª—è –ø–µ—Ä–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤

–®–ê–ì 4: –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –°–ò–ì–ù–ê–õ–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–µ–∫–æ–º–ø–æ–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏ –æ–ø—Ä–µ–¥–µ–ª–∏ –û–î–ò–ù –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∏–≥–Ω–∞–ª —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

–°–ò–ì–ù–ê–õ–´:
- "price_sensitive" - –≤–æ–ø—Ä–æ—Å—ã –æ —Ü–µ–Ω–∞—Ö, —Å—Ç–æ–∏–º–æ—Å—Ç–∏, —Å–∫–∏–¥–∫–∞—Ö, —Å–ø–æ—Å–æ–±–∞—Ö –æ–ø–ª–∞—Ç—ã, —Ä–∞—Å—Å—Ä–æ—á–∫–µ, –ø–æ–¥–æ–∑—Ä–µ–Ω–∏—è –≤ –æ–±–º–∞–Ω–µ
- "anxiety_about_child" - —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Ä–µ–±–µ–Ω–∫–∞ (—Å—Ç–µ—Å–Ω–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –Ω–µ—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å, —Å—Ç—Ä–∞—Ö–∏, —Ç—Ä–∞–≤–º—ã, —Å–ª–æ–∂–Ω–æ—Å—Ç–∏)
- "ready_to_buy" - –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∑–∞–ø–∏—Å–∏: —è–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –∑–∞–ø–∏—Å—å –ò–õ–ò –∫—Ä–∞—Ç–∫–∏–µ –¥–µ–ª–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ –ª–æ–≥–∏—Å—Ç–∏–∫–µ
- "exploring_only" - –æ–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –æ —à–∫–æ–ª–µ, –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏, –∫—É—Ä—Å–∞—Ö –±–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –ø–æ–∫—É–ø–∫–µ

–í–ê–ñ–ù–û: –ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π —Ç–æ–Ω ("—Ä–∞–∑–≤–æ–¥", "–ª–∞–±—É–¥–∞", "–±–∞–±–ª–æ —Ç—è–Ω–µ—Ç–µ") —á–∞—Å—Ç–æ = price_sensitive (–Ω–µ–¥–æ–≤–µ—Ä–∏–µ –∫ —Ü–µ–Ω–µ)

–ü–†–ê–í–ò–õ–ê –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø:
1. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –í–°–ï –¥–µ–∫–æ–º–ø–æ–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –≤ —Å–æ–≤–æ–∫—É–ø–Ω–æ—Å—Ç–∏
2. –í–ê–ñ–ù–û: –£—á–∏—Ç—ã–≤–∞–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è - –∫—Ä–∞—Ç–∫–∏–π —Ç–µ–ª–µ–≥—Ä–∞—Ñ–Ω—ã–π —Å—Ç–∏–ª—å (< 5 —Å–ª–æ–≤) —á–∞—Å—Ç–æ = ready_to_buy
3. –£–°–ò–õ–ï–ù–ù–ê–Ø –ò–ù–ï–†–¶–ò–Ø –¥–ª—è price_sensitive: –ï—Å–ª–∏ –¥–∏–∞–ª–æ–≥ –Ω–∞—á–∞–ª—Å—è —Å –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –æ —Ü–µ–Ω–µ - —Å–æ—Ö—Ä–∞–Ω—è–π price_sensitive —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é 85%
   - –í–æ–ø—Ä–æ—Å—ã –ø—Ä–æ "–æ—Ç–∑—ã–≤—ã", "–≥–∞—Ä–∞–Ω—Ç–∏–∏", "—Ä–µ–∞–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç" –æ—Ç –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—è = –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ price_sensitive
   - –ú–µ–Ω—è–π –Ω–∞ exploring_only –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —Ç–æ–Ω —Å—Ç–∞–ª –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–º –∏ –≤–æ–ø—Ä–æ—Å—ã –Ω–µ –ø—Ä–æ —Ü–µ–Ω–Ω–æ—Å—Ç—å
4. –ü–ï–†–ï–•–û–î–´ –°–ò–ì–ù–ê–õ–û–í:
   - exploring_only ‚Üí ready_to_buy: –ø—Ä–∏ —Å–ª–æ–≤–∞—Ö "–∑–∞–ø–∏—Å–∞—Ç—å", "trial", "book us", "–ø—Ä–æ–±–Ω–æ–µ"
   - price_sensitive ‚Üí ready_to_buy: –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –æ—Ç —Å–∫–∏–¥–æ–∫ –∫ –∑–∞–ø–∏—Å–∏ ("–ø–æ–¥—Ö–æ–¥–∏—Ç", "–∑–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ")
   - –ú–Ω–æ–≥–æ–¥–µ—Ç–Ω—ã–µ —Ä–æ–¥–∏—Ç–µ–ª–∏: —Å–Ω–∞—á–∞–ª–∞ price_sensitive (—Å–∫–∏–¥–∫–∏), –ø–æ—Ç–æ–º ready_to_buy (–∑–∞–ø–∏—Å—å)
5. –í—ã–±–∏—Ä–∞–π –Ω–∞–∏–±–æ–ª–µ–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π —Å–∏–≥–Ω–∞–ª –ø–æ –ø–æ—Ä—è–¥–∫—É: ready_to_buy > anxiety_about_child > price_sensitive > exploring_only
6. –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ—à—å –æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å - –∏—Å–ø–æ–ª—å–∑—É–π "exploring_only"

–ú–ê–†–ö–ï–†–´ price_sensitive:
- –ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ —Ü–µ–Ω–µ: "–¥–æ—Ä–æ–≥–æ", "—Å —É–º–∞ —Å–æ—à–ª–∏", "30 —Ç—ã—Å—è—á?!", "–ø–æ—á–µ–º—É —Ç–∞–∫ –º–Ω–æ–≥–æ"
- –ü–æ–¥–æ–∑—Ä–µ–Ω–∏—è –≤ –æ–±–º–∞–Ω–µ: "—Ä–∞–∑–≤–æ–¥", "–ª–∞–±—É–¥–∞", "–±–∞–±–ª–æ —Ç—è–Ω–µ—Ç–µ", "–º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–∞—è —á—É—à—å"
- –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤ —Ü–µ–Ω–Ω–æ—Å—Ç–∏: "—Ä–µ–∞–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?", "–ø–æ–∫–∞–∂–∏—Ç–µ –æ—Ç–∑—ã–≤—ã", "–≥–∞—Ä–∞–Ω—Ç–∏–∏ –∫–∞–∫–∏–µ"
- –°–∫–µ–ø—Ç–∏—Ü–∏–∑–º –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º: "—Ç–æ–ª–∫ –∫–∞–∫–æ–π", "–∏ —á—Ç–æ —ç—Ç–æ –¥–∞—Å—Ç", "–∑–∞—á–µ–º –ø–µ—Ä–µ–ø–ª–∞—á–∏–≤–∞—Ç—å"
- –í–ê–ñ–ù–û: —Å–æ—Ö—Ä–∞–Ω—è–π price_sensitive –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ –≤—Å–µ–≥–æ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞

–ú–ê–†–ö–ï–†–´ ready_to_buy:
- –Ø–≤–Ω—ã–µ: "—Ö–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å", "–∑–∞–ø–∏—à–∏—Ç–µ –Ω–∞—Å", "–∫–∞–∫ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è", "–≥–¥–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è", "book us"
- –ö–æ–Ω—Ç–µ–∫—Å—Ç—É–∞–ª—å–Ω—ã–µ –∫—Ä–∞—Ç–∫–∏–µ (—Ç–µ–ª–µ–≥—Ä–∞—Ñ–Ω—ã–π —Å—Ç–∏–ª—å):
  * "–ö—É—Ä—Å [–Ω–∞–∑–≤–∞–Ω–∏–µ]. –ö–æ–≥–¥–∞ —Å—Ç–∞—Ä—Ç?" - –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
  * "–û–Ω–ª–∞–π–Ω –µ—Å—Ç—å?" - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞  
  * "–¶–µ–Ω–∞? –°—Ä–æ–∫–∏?" - —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ —Ä–µ—à–µ–Ω–∏–µ–º
  * "–û–ø–ª–∞—Ç–∞?", "–°—Å—ã–ª–∫—É", "–î–æ–∫—É–º–µ–Ω—Ç—ã?" - –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∑–∞–ø–∏—Å–∏
  * "Trial –µ—Å—Ç—å?" - —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–ª–µ–Ω–≥ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
- –ü–∞—Ç—Ç–µ—Ä–Ω: —Ñ–æ–∫—É—Å –Ω–∞ –ü–†–û–¶–ï–°–°–ï –∏ –õ–û–ì–ò–°–¢–ò–ö–ï, –∞ –Ω–µ –Ω–∞ —Å—É—Ç–∏ –∫—É—Ä—Å–æ–≤

–ü–†–ò–ú–ï–†–´:
price_sensitive: "30 —Ç—ã—Å—è—á?!", "—Ä–∞–∑–≤–æ–¥ –¥–ª—è —Ä–æ–¥–∏—Ç–µ–ª–µ–π?", "—Ä–µ–∞–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?"
anxiety_about_child: "—Å—ã–Ω —Å—Ç–µ—Å–Ω–∏—Ç–µ–ª—å–Ω—ã–π", "–±–æ–∏—Ç—Å—è –≤—ã—Å—Ç—É–ø–∞—Ç—å", "–Ω–µ—É–≤–µ—Ä–µ–Ω–Ω—ã–π"
ready_to_buy: "–∑–∞–ø–∏—à–∏—Ç–µ –Ω–∞—Å", "–∫–æ–≥–¥–∞ —Å—Ç–∞—Ä—Ç?", "–æ–Ω–ª–∞–π–Ω –µ—Å—Ç—å?", "trial?"
exploring_only: "—Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —à–∫–æ–ª–µ", "–∫–∞–∫–∞—è –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è?", "—á–µ–º –∑–∞–Ω–∏–º–∞–µ—Ç–µ—Å—å?", "—á—Ç–æ –∑–∞ –∫—É—Ä—Å—ã?", "–∫–∞–∫–∏–µ –Ω–∞–≤—ã–∫–∏ —Ä–∞–∑–≤–∏–≤–∞–µ—Ç–µ?"

–ú–ê–†–ö–ï–†–´ exploring_only (—É–∫—Ä–∞–∏–Ω—Å–∫–∏–µ —Ä–æ–¥–∏—Ç–µ–ª–∏-–∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–∏):
- "—Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ", "—á—Ç–æ —ç—Ç–æ –∑–∞ —à–∫–æ–ª–∞", "—á–µ–º –∏–º–µ–Ω–Ω–æ –∑–∞–Ω–∏–º–∞–µ—Ç–µ—Å—å"
- "–∫–∞–∫–∏–µ –Ω–∞–≤—ã–∫–∏", "–∫–∞–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞", "—á—Ç–æ –¥–∞–µ—Ç —Ä–µ–±–µ–Ω–∫—É"
- "—á–µ–º –æ—Ç–ª–∏—á–∞–µ—Ç–µ—Å—å", "–ø–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ –≤—ã", "–∫–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥"
- –ë–ï–ó —É–ø–æ–º–∏–Ω–∞–Ω–∏—è —Ü–µ–Ω—ã, –ø—Ä–æ–±–ª–µ–º —Ä–µ–±–µ–Ω–∫–∞ –∏–ª–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è

–°–¢–ò–õ–¨ –ö–ê–ö –ò–ù–î–ò–ö–ê–¢–û–†:
- –¢–µ–ª–µ–≥—Ä–∞—Ñ–Ω—ã–π —Å—Ç–∏–ª—å (1-3 —Å–ª–æ–≤–∞) + –ª–æ–≥–∏—Å—Ç–∏–∫–∞ = ready_to_buy —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é 80%
- –†–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏—è–º–∏ = exploring_only –∏–ª–∏ anxiety_about_child
- –ö—Ä–∞—Ç–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã –æ —Ü–µ–Ω–µ –ë–ï–ó –¥—Ä—É–≥–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ = price_sensitive
- –ö—Ä–∞—Ç–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã –æ —Ü–µ–Ω–µ –° –≤–æ–ø—Ä–æ—Å–∞–º–∏ –æ –ø—Ä–æ—Ü–µ—Å—Å–µ = ready_to_buy

"""
    
    def _get_response_format_section(self) -> str:
        """–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON-–æ—Ç–≤–µ—Ç–∞"""
        return (
            "=== –§–û–†–ú–ê–¢ JSON –û–¢–í–ï–¢–ê (–ú–ò–ù–ò–ú–ê–õ–¨–ù–´–ô) ===\n\n"
            "1) success:\n{\n  \"status\": \"success\",\n  \"documents\": [\"doc1.md\", ...],\n  \"decomposed_questions\": [\"–í–æ–ø—Ä–æ—Å 1?\", ...],\n  \"user_signal\": \"price_sensitive\",  // –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –æ–¥–∏–Ω –∏–∑ 4 —Å–∏–≥–Ω–∞–ª–æ–≤\n  \"social_context\": \"greeting\"  // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –±—ã–ª —Å–æ—Ü–∏–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç\n}\n\n"
            "2) offtopic:\n{\n  \"status\": \"offtopic\",\n  \"decomposed_questions\": [],\n  \"user_signal\": \"exploring_only\",  // –¥–ª—è offtopic –≤—Å–µ–≥–¥–∞ exploring_only\n  \"social_context\": \"farewell\"  // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ\n}\n"
            "–í–ê–ñ–ù–û: –¥–ª—è offtopic –ù–ï –≥–µ–Ω–µ—Ä–∏—Ä—É–π message - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–∞–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—Ä–∞–∑–∞\n\n"
            "3) need_simplification:\n{\n  \"status\": \"need_simplification\",\n  \"message\": \"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–¥–∞–≤–∞–π—Ç–µ –Ω–µ –±–æ–ª–µ–µ —Ç—Ä—ë—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –∑–∞ —Ä–∞–∑. –ù–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞—á–Ω–∏—Ç–µ —Å —Å–∞–º–æ–≥–æ –≤–∞–∂–Ω–æ–≥–æ –¥–ª—è –≤–∞—Å.\",\n  \"decomposed_questions\": [\"–í–æ–ø—Ä–æ—Å 1?\", ...],\n  \"user_signal\": \"exploring_only\",  // –æ–ø—Ä–µ–¥–µ–ª–∏ —Å–∏–≥–Ω–∞–ª –¥–∞–∂–µ –¥–ª—è need_simplification\n  \"social_context\": \"apology\"  // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ\n}\n\n"
            "–¢–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–π JSON, –±–µ–∑ markdown –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –ü–æ–ª–µ decomposed_questions –≤—Å–µ–≥–¥–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç.\n"
            "–ü–æ–ª–µ user_signal –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û (price_sensitive|anxiety_about_child|ready_to_buy|exploring_only).\n"
            "–ü–æ–ª–µ social_context –¥–æ–±–∞–≤–ª—è–π –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –±—ã–ª —Å–æ—Ü–∏–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (greeting/thanks/apology/farewell).\n"
        )
    
    def _fallback_response(self) -> dict:
        """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –ø—Ä–∏ –ª—é–±—ã—Ö –æ—à–∏–±–∫–∞—Ö"""
        return {
            "status": "offtopic",
            "message": DEFAULT_FALLBACK,
            "decomposed_questions": [],
            "user_signal": "exploring_only"
        }