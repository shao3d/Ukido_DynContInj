# üéØ –ü–ª–∞–Ω –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–º–ø—Ç–∞ Gemini Router (v2.0)

## üìä –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### Dataflow —Å–∏—Å—Ç–µ–º—ã:
1. **User ‚Üí main.py**: –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å, —É–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–µ–π
2. **main.py ‚Üí Router (Gemini)**: –ü–µ—Ä–µ–¥–∞–µ—Ç message + history + user_id
3. **Router –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:
   - `status`: success/offtopic/need_simplification
   - `documents`: —Å–ø–∏—Å–æ–∫ –¥–æ 4 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (–Ω–∞–∑–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤)
   - `decomposed_questions`: —Ä–∞–∑–±–∏—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã
   - `user_signal`: price_sensitive/anxiety/ready_to_buy/exploring
   - `social_context`: greeting/thanks/farewell
4. **main.py ‚Üí ResponseGenerator (Claude)**: –ü–µ—Ä–µ–¥–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç Router + history
5. **Claude –∑–∞–≥—Ä—É–∂–∞–µ—Ç**: –ü–æ–ª–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏–∑ data/documents_compressed/
6. **Claude –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç**: –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç —Å —É—á–µ—Ç–æ–º user_signal –∏ tone_adaptation

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞—Ö–æ–¥–∫–∏:
- **summaries.json (46KB) –¶–ï–õ–ò–ö–û–ú –≤–∫–ª—é—á–∞–µ—Ç—Å—è –≤ –ö–ê–ñ–î–´–ô –∑–∞–ø—Ä–æ—Å –∫ Gemini**
- **Router –ù–ï —á–∏—Ç–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, —Ç–æ–ª—å–∫–æ –≤—ã–±–∏—Ä–∞–µ—Ç –∏—Ö –ø–æ summaries**
- **Claude –∑–∞–≥—Ä—É–∂–∞–µ—Ç –ø–æ–ª–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã (2-12KB –∫–∞–∂–¥—ã–π) –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç Router**
- **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ Gemini –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ system_content (–≤–∫–ª—é—á–∞—è summaries)**

## üî• –ì–ª–∞–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–º–ø—Ç–∞ (45.7K –∏–∑ 50K)

1. **summaries.json –∑–∞–Ω–∏–º–∞–µ—Ç ~46K** - —ç—Ç–æ 80% –≤—Å–µ–≥–æ –ø—Ä–æ–º–ø—Ç–∞!
   - –°–æ–¥–µ—Ä–∂–∏—Ç –∏–∑–±—ã—Ç–æ—á–Ω—ã–µ –ø–æ–ª—è: typical_questions, related_docs, unique_value
   - –î—É–±–ª–∏—Ä—É–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –º–µ–∂–¥—É trigger_words –∏ typical_questions
   
2. **Classification section ~15K** - –º–Ω–æ–∂–µ—Å—Ç–≤–æ –ø—Ä–∏–º–µ—Ä–æ–≤ –∏ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π
   - 170+ —Å—Ç—Ä–æ–∫ —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ –º–∞—Ä–∫–µ—Ä–∞–º–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞
   - –î—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –ø—Ä–∏–º–µ—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
   
3. **Decomposition section ~5K** - –∏–∑–±—ã—Ç–æ—á–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã
   - –ü–æ–ª–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ –≤–º–µ—Å—Ç–æ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤

## üìã –£–º–Ω—ã–π –ø–ª–∞–Ω –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (7 —ç—Ç–∞–ø–æ–≤)

### –≠—Ç–∞–ø 1: –ö–æ–º–ø–∞–∫—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è summaries (—ç–∫–æ–Ω–æ–º–∏—è ~35K!) üî•
**–¢–µ–∫—É—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ summaries.json –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞:**
```json
{
  "core_topics": "300+ —Å–∏–º–≤–æ–ª–æ–≤ –æ–ø–∏—Å–∞–Ω–∏—è",
  "key_facts": "400+ —Å–∏–º–≤–æ–ª–æ–≤ —Ñ–∞–∫—Ç–æ–≤",
  "typical_questions": ["10-15 –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ 50 —Å–∏–º–≤–æ–ª–æ–≤"],
  "trigger_words": ["30+ —Å–ª–æ–≤"],
  "related_docs": ["3-4 –¥–æ–∫—É–º–µ–Ω—Ç–∞"],
  "unique_value": "200+ —Å–∏–º–≤–æ–ª–æ–≤"
}
```

**–ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ summaries_compact.json:**
```json
{
  "keywords": ["–æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ trigger_words, –º–∞–∫—Å–∏–º—É–º 20 —Å–ª–æ–≤"],
  "facts": "100 —Å–∏–º–≤–æ–ª–æ–≤ –∫–ª—é—á–µ–≤—ã—Ö —Ñ–∞–∫—Ç–æ–≤"
}
```
- –£–±—Ä–∞—Ç—å typical_questions (–¥—É–±–ª–∏—Ä—É—é—Ç trigger_words)
- –£–±—Ä–∞—Ç—å related_docs (Router —Å–∞–º –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–≤—è–∑–∏)
- –£–±—Ä–∞—Ç—å unique_value (–∏–∑–±—ã—Ç–æ—á–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ)
- –°–æ–∫—Ä–∞—Ç–∏—Ç—å core_topics –¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤
- –û–±—ä–µ–¥–∏–Ω–∏—Ç—å trigger_words –≤ –µ–¥–∏–Ω—ã–π –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Å–ø–∏—Å–æ–∫

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–∞–∑–º–µ—Ä: 10-12K –≤–º–µ—Å—Ç–æ 46K**

### –≠—Ç–∞–ø 2: –í—ã–Ω–æ—Å –ø—Ä–∏–º–µ—Ä–æ–≤ –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ (—ç–∫–æ–Ω–æ–º–∏—è ~3K)
–°–æ–∑–¥–∞—Ç—å `router_decomposition.py`:
```python
DECOMPOSITION_PATTERNS = {
    "greeting_business": "–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + –≤–æ–ø—Ä–æ—Å ‚Üí [–≤–æ–ø—Ä–æ—Å]",
    "multiple_questions": "–í–æ–ø—Ä–æ—Å1 –∏ –≤–æ–ø—Ä–æ—Å2 ‚Üí [–≤–æ–ø—Ä–æ—Å1, –≤–æ–ø—Ä–æ—Å2]",
    "context_question": "–ê? ‚Üí –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏"
}
```
–ó–∞–≥—Ä—É–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É.

### –≠—Ç–∞–ø 3: –ö–æ–º–ø–∞–∫—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è Classification (—ç–∫–æ–Ω–æ–º–∏—è ~8K)
- –í—ã–Ω–µ—Å—Ç–∏ –¥–µ—Ç–∞–ª—å–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã –≤ —Å–ª–æ–≤–∞—Ä—å Python
- –í –ø—Ä–æ–º–ø—Ç–µ –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ç–æ–ø-5 –º–∞—Ä–∫–µ—Ä–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –≤–º–µ—Å—Ç–æ –ø—Ä–∏–º–µ—Ä–æ–≤:
  ```
  price_sensitive: "–¥–æ—Ä–æ–≥–æ|—Ä–∞–∑–≤–æ–¥|30 —Ç—ã—Å—è—á" + –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π —Ç–æ–Ω
  anxiety: "—Å—Ç–µ—Å–Ω–∏—Ç–µ–ª—å–Ω—ã–π|–±–æ–∏—Ç—Å—è|–∑–∞–º–∫–Ω—É—Ç—ã–π" + —Ç—Ä–µ–≤–æ–≥–∞ –æ —Ä–µ–±–µ–Ω–∫–µ
  ready_to_buy: "–∑–∞–ø–∏—à–∏—Ç–µ|—Å–æ–≥–ª–∞—Å–Ω—ã|–¥–µ–π—Å—Ç–≤—É–µ–º" + –∫—Ä–∞—Ç–∫–∏–π —Å—Ç–∏–ª—å
  ```

### –≠—Ç–∞–ø 4: –£–º–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ summaries (—ç–∫–æ–Ω–æ–º–∏—è ~5K)
- –ù–ï –∑–∞–≥—Ä—É–∂–∞—Ç—å –í–°–ï summaries –≤ –ø—Ä–æ–º–ø—Ç
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–≤—É—Ö—ç—Ç–∞–ø–Ω—ã–π –ø–æ–¥—Ö–æ–¥:
  1. –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º (–∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–ª—å–∫–æ keywords)
  2. –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

### –≠—Ç–∞–ø 5: –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- –í—ã–Ω–µ—Å—Ç–∏ –í–°–Æ —Å—Ç–∞—Ç–∏–∫—É –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π CACHED_PROMPT
- –ö–µ—à–∏—Ä–æ–≤–∞—Ç—å: —Ä–æ–ª–∏, –ø—Ä–∞–≤–∏–ª–∞ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏, —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø–æ–¥–≥—Ä—É–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ: user_message + history + –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ summaries

### –≠—Ç–∞–ø 6: –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –ø—Ä–∞–≤–∏–ª–∞—Ö
- –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –ø—Ä–∞–≤–∏–ª–∞ –≤—ã–±–æ—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã –≤–º–µ—Å—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –æ–ø–∏—Å–∞–Ω–∏–π
- –£–±—Ä–∞—Ç—å –∏–∑–±—ã—Ç–æ—á–Ω—ã–µ –ü–†–ò–ú–ï–†–´ (–æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ)

### –≠—Ç–∞–ø 7: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è response format
- –°–æ–∫—Ä–∞—Ç–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ JSON —Ñ–æ—Ä–º–∞—Ç–∞
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ö–µ–º—É –≤–º–µ—Å—Ç–æ –ø—Ä–∏–º–µ—Ä–æ–≤

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

**–î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
- summaries.json: 46K
- classification: 15K  
- decomposition: 5K
- –æ—Å—Ç–∞–ª—å–Ω–æ–µ: 3K
**–ò–¢–û–ì–û: 45.7K (91%)**

**–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
- summaries_compact: 10K (-36K!)
- classification: 7K (-8K)
- decomposition: 2K (-3K)
- –æ—Å—Ç–∞–ª—å–Ω–æ–µ: 3K
**–ò–¢–û–ì–û: 22K (44%)**

**–≠–∫–æ–Ω–æ–º–∏—è: 23.7K —Ç–æ–∫–µ–Ω–æ–≤ (52% –ø—Ä–æ–º–ø—Ç–∞!)**

## ‚ö° –ü–æ—Ä—è–¥–æ–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

1. **–°–æ–∑–¥–∞—Ç—å summaries_compact.json** —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
2. **–°–æ–∑–¥–∞—Ç—å router_markers.py** –¥–ª—è –≤—ã–Ω–µ—Å–µ–Ω–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤ —Å–∏–≥–Ω–∞–ª–æ–≤
3. **–û–±–Ω–æ–≤–∏—Ç—å Router** –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–æ–º–ø–∞–∫—Ç–Ω—ã–º–∏ summaries
4. **–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç—å _get_classification_section()** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞
5. **–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç—å _get_decomposition_section()** - —É–±—Ä–∞—Ç—å –ø—Ä–∏–º–µ—Ä—ã
6. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—ã–π —ç—Ç–∞–ø** —á–µ—Ä–µ–∑ sandbox_v2.py
7. **–ü—Ä–æ–≥–Ω–∞—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã** –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–≥—Ä–µ—Å—Å–∏–∏

## ‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–æ–º–µ–Ω—Ç—ã –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

1. **–ù–ï —Ç—Ä–æ–≥–∞—Ç—å –ª–æ–≥–∏–∫—É –≤—ã–±–æ—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤** - Router –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏—è
2. **–ù–ï –º–µ–Ω—è—Ç—å —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ Router** - Claude –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
3. **–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–∞—Ä–∫–µ—Ä—ã** –¥–ª—è ready_to_buy –∏ anxiety
4. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å implicit questions** –¥–ª—è ready_to_buy

## üéØ –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

- –ü—Ä–æ–º–ø—Ç Router < 25K —Ç–æ–∫–µ–Ω–æ–≤
- –í—Å–µ —Ç–µ—Å—Ç—ã State Machine –ø—Ä–æ—Ö–æ–¥—è—Ç (>65%)
- –¢–æ—á–Ω–æ—Å—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤ –Ω–µ –ø–∞–¥–∞–µ—Ç
- –õ–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –Ω–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è
- –°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –∑–∞–ø—Ä–æ—Å —Å–Ω–∏–∂–∞–µ—Ç—Å—è –Ω–∞ 20%

---
*–ü–ª–∞–Ω —Å–æ—Å—Ç–∞–≤–ª–µ–Ω 20.08.2025 –ø–æ—Å–ª–µ –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã —Å–∏—Å—Ç–µ–º—ã Ukido v0.9.7*