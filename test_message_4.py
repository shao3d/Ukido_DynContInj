#!/usr/bin/env python3
"""
–¢–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ 4-–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –¥–∏–∞–ª–æ–≥–∞ 7
–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–º–µ–Ω–∏ –º–µ—Ç–æ–¥–∏—Å—Ç–∞ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö
"""

import requests
import json
import time

def test_single_message():
    """–¢–µ—Å—Ç–∏—Ä—É–µ–º –≤–æ–ø—Ä–æ—Å –ø—Ä–æ —Å—É–ø–µ—Ä–≤–∏–∑–∏–∏"""
    
    server_url = "http://localhost:8000"
    user_id = f"test_message4_{int(time.time())}"
    
    # –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞—ë–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞ (–ø–µ—Ä–≤—ã–µ 3 —Å–æ–æ–±—â–µ–Ω–∏—è)
    messages = [
        "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –∫–æ–ª–ª–µ–≥–∏! –Ø —Å–∞–º–∞ –ø–µ–¥–∞–≥–æ–≥, –∏—â—É –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ –¥–ª—è —Å—ã–Ω–∞",
        "–ö–∞–∫–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –º–µ—Ç–æ–¥–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ? –ú–æ–Ω—Ç–µ—Å—Å–æ—Ä–∏, –í–∞–ª—å–¥–æ—Ä—Ñ, –∏–ª–∏ —Å–≤–æ—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞?",
        "–ö–∞–∫ –≤—ã —Ä–∞–±–æ—Ç–∞–µ—Ç–µ —Å —Ä–∞–∑–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏ —Ç–µ–º–ø–µ—Ä–∞–º–µ–Ω—Ç–∞? –•–æ–ª–µ—Ä–∏–∫–∏ vs –º–µ–ª–∞–Ω—Ö–æ–ª–∏–∫–∏?"
    ]
    
    print("üîÑ –°–æ–∑–¥–∞—ë–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞ (–ø–µ—Ä–≤—ã–µ 3 —Å–æ–æ–±—â–µ–Ω–∏—è)...")
    for i, msg in enumerate(messages, 1):
        print(f"\n[{i}/3] –û—Ç–ø—Ä–∞–≤–ª—è–µ–º: {msg[:50]}...")
        response = requests.post(
            f"{server_url}/chat",
            json={"user_id": user_id, "message": msg},
            timeout=30
        )
        if response.status_code == 200:
            print(f"‚úÖ –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω")
        else:
            print(f"‚ùå –û—à–∏–±–∫–∞: {response.status_code}")
        time.sleep(1)  # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
    
    # –¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ 4-–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    test_message = "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ! –ê –µ—Å—Ç—å –ª–∏ —É –≤–∞—Å —Å—É–ø–µ—Ä–≤–∏–∑–∏–∏ –¥–ª—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π? –û–±–º–µ–Ω –æ–ø—ã—Ç–æ–º?"
    
    print("\n" + "="*60)
    print("üìù –¢–ï–°–¢–û–í–û–ï –°–û–û–ë–©–ï–ù–ò–ï ‚Ññ4")
    print("="*60)
    print(f"USER: {test_message}")
    print("-"*60)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
    start_time = time.time()
    response = requests.post(
        f"{server_url}/chat",
        json={
            "user_id": user_id,
            "message": test_message
        },
        timeout=30
    )
    elapsed_time = time.time() - start_time
    
    if response.status_code == 200:
        data = response.json()
        bot_response = data.get('response', '–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞')
        
        print(f"BOT: {bot_response}")
        print("-"*60)
        print(f"‚è±Ô∏è –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: {elapsed_time:.2f}—Å")
        print(f"üìä Intent: {data.get('intent', 'unknown')}")
        print(f"üìä Signal: {data.get('user_signal', 'unknown')}")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∏
        print("\n" + "="*60)
        print("üîç –ê–ù–ê–õ–ò–ó –û–¢–í–ï–¢–ê:")
        print("="*60)
        
        # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–µ–Ω–∏ –º–µ—Ç–æ–¥–∏—Å—Ç–∞
        if "–û–ª—å–≥–∞ –ú–∏—Ä–Ω–∞—è" in bot_response:
            print("‚ùå –ü–†–û–ë–õ–ï–ú–ê: –í—Å—ë –µ—â—ë —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è '–û–ª—å–≥–∞ –ú–∏—Ä–Ω–∞—è'")
        elif "–ï–ª–µ–Ω–∞ –ú–∏—Ä–æ—à–Ω–∏–∫–æ–≤–∞" in bot_response:
            print("‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è '–ï–ª–µ–Ω–∞ –ú–∏—Ä–æ—à–Ω–∏–∫–æ–≤–∞'")
        elif "–º–µ—Ç–æ–¥–∏—Å—Ç" in bot_response.lower():
            print("‚ö†Ô∏è –ú–µ—Ç–æ–¥–∏—Å—Ç —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –±–µ–∑ –∏–º–µ–Ω–∏")
        else:
            print("‚ÑπÔ∏è –ú–µ—Ç–æ–¥–∏—Å—Ç –Ω–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –≤ –æ—Ç–≤–µ—Ç–µ")
        
        # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏—à–Ω–µ–≥–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
        if bot_response.startswith("–ü—Ä–∏–≤–µ—Ç!"):
            print("‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê: –û—Ç–≤–µ—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å '–ü—Ä–∏–≤–µ—Ç!' –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –¥–∏–∞–ª–æ–≥–∞")
        else:
            print("‚úÖ –û—Ç–≤–µ—Ç –ù–ï –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è")
        
        # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—Ä—É–≥–∏—Ö –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π
        if "—Ç—Ä—ë—Ö–º–µ—Å—è—á–Ω" in bot_response or "3 –º–µ—Å—è—Ü–∞" in bot_response or "—Ç—Ä–∏ –º–µ—Å—è—Ü–∞" in bot_response:
            print("‚ÑπÔ∏è –£–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è —Ç—Ä—ë—Ö–º–µ—Å—è—á–Ω–æ–µ –º–µ–Ω—Ç–æ—Ä—Å—Ç–≤–æ (—ç—Ç–æ –µ—Å—Ç—å –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö)")
        
        if "–≤–æ—Ä–∫—à–æ–ø" in bot_response.lower():
            print("‚ÑπÔ∏è –£–ø–æ–º–∏–Ω–∞—é—Ç—Å—è –≤–æ—Ä–∫—à–æ–ø—ã (—ç—Ç–æ –µ—Å—Ç—å –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö)")
            
        if "—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü" in bot_response.lower():
            print("‚ÑπÔ∏è –£–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (—ç—Ç–æ –µ—Å—Ç—å –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö)")
        
    else:
        print(f"‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: {response.status_code}")
        print(response.text)

if __name__ == "__main__":
    print("üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ 4-–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –¥–∏–∞–ª–æ–≥–∞ ‚Ññ7")
    print("üìã –¢–µ–º–∞: –°—É–ø–µ—Ä–≤–∏–∑–∏–∏ –¥–ª—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π")
    print()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞
    try:
        health = requests.get("http://localhost:8000/health", timeout=2)
        if health.status_code == 200:
            print("‚úÖ –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω\n")
            test_single_message()
        else:
            print("‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç, –Ω–æ health check failed")
    except:
        print("‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ http://localhost:8000")
        print("üí° –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä: python src/main.py")